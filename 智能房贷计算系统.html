
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æ™ºèƒ½æˆ¿è´·æ¨æ¼”ç³»ç»Ÿ v10.0</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f0f4f8;--surface:#fff;--surface2:#f7f9fc;--surface3:#eef2f7;
  --border:#d8e1ec;--border2:#e8eef6;
  --text:#2d3748;--text2:#4a5568;--text3:#7a8fa8;
  --primary:#5a8dee;--primary-dim:rgba(90,141,238,.10);--primary-mid:rgba(90,141,238,.20);
  --green:#38a169;--green-dim:rgba(56,161,105,.10);
  --red:#e05252;--red-dim:rgba(224,82,82,.10);
  --yellow:#d97706;--yellow-dim:rgba(217,119,6,.10);
  --purple:#7c5cbf;--purple-dim:rgba(124,92,191,.10);
  --orange:#c2691a;--orange-dim:rgba(194,105,26,.10);
  --cyan:#2b8fa3;--cyan-dim:rgba(43,143,163,.10);
  --bonus:#9b4dca;--bonus-dim:rgba(155,77,202,.10);
  --teal:#1a9e8f;--teal-dim:rgba(26,158,143,.10);
  --radius:10px;--radius-sm:6px;
  --shadow:0 1px 4px rgba(60,80,120,.07);--shadow-md:0 2px 10px rgba(60,80,120,.10);
  --fs-xs:10px;--fs-sm:11px;--fs-base:12.5px;--fs-md:13.5px;--fs-lg:15px;--fs-xl:18px;--fs-2xl:22px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Noto Sans SC',sans-serif;background:var(--bg);color:var(--text);font-size:var(--fs-base);height:100vh;overflow:hidden;display:flex;flex-direction:column;padding:6px;gap:6px}
.header{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:linear-gradient(90deg,#e8f0fe,#f3eeff);border:1px solid var(--border);border-radius:var(--radius);flex-shrink:0;box-shadow:var(--shadow)}
.header-left{display:flex;align-items:center;gap:10px}
.logo{font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;background:linear-gradient(135deg,#5a8dee,#9b4dca);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-sub{font-size:var(--fs-xs);color:var(--text3)}
.header-badges{display:flex;gap:6px}
.badge{font-size:var(--fs-xs);padding:3px 10px;border-radius:10px;font-weight:600;font-family:'JetBrains Mono',monospace}
.badge-blue{background:var(--primary-dim);color:var(--primary);border:1px solid var(--primary-mid)}
.badge-green{background:var(--green-dim);color:var(--green);border:1px solid rgba(56,161,105,.25)}
.badge-purple{background:var(--purple-dim);color:var(--purple);border:1px solid rgba(124,92,191,.25)}
.badge-bonus{background:var(--bonus-dim);color:var(--bonus);border:1px solid rgba(155,77,202,.25)}
.badge-teal{background:var(--teal-dim);color:var(--teal);border:1px solid rgba(26,158,143,.25)}
.layout{display:flex;gap:6px;flex:1;overflow:hidden}
.sidebar{width:272px;flex-shrink:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;overflow:hidden;box-shadow:var(--shadow)}
.main{flex:1;display:flex;flex-direction:column;gap:6px;overflow:hidden;min-width:0}
.sidebar-inner{flex:1;overflow-y:auto;padding:7px 8px;display:flex;flex-direction:column;gap:5px}
.sidebar-inner::-webkit-scrollbar{width:4px}
.sidebar-inner::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.s-head{font-size:var(--fs-xs);font-weight:700;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:3px;display:flex;align-items:center;gap:5px}
.s-head::after{content:'';flex:1;height:1px;background:var(--border)}
.field-group{display:flex;gap:5px;margin-bottom:4px}
.field{flex:1}
label{display:block;font-size:var(--fs-xs);color:var(--text3);margin-bottom:2px;font-weight:500}
input,select{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:var(--radius-sm);font-size:var(--fs-sm);padding:3px 7px;height:26px;font-family:'JetBrains Mono',monospace;transition:border-color .15s,box-shadow .15s}
input:focus,select:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 2px var(--primary-dim)}
input::placeholder{color:var(--text3);font-size:var(--fs-xs)}
.input-wrap{position:relative}
.input-unit{position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:var(--fs-xs);color:var(--text3);pointer-events:none;font-family:'JetBrains Mono',monospace}
.loan-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:7px}
.loan-box.com{border-left:3px solid var(--primary)}
.loan-box.fund{border-left:3px solid var(--cyan)}
.loan-box.bonus-box{border-left:3px solid var(--bonus);background:rgba(155,77,202,.04)}
.calc-btn{width:100%;height:33px;border:none;border-radius:var(--radius-sm);background:linear-gradient(135deg,#5a8dee,#9b4dca);color:white;font-weight:700;font-size:var(--fs-md);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:opacity .15s,transform .1s,box-shadow .15s;box-shadow:0 2px 8px rgba(90,141,238,.30);flex-shrink:0}
.calc-btn:hover{opacity:.92;box-shadow:0 4px 14px rgba(90,141,238,.40)}
.calc-btn:active{transform:scale(.98)}
.metrics{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;flex-shrink:0}
.metric{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;position:relative;overflow:hidden;box-shadow:var(--shadow)}
.metric::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.metric.blue::before{background:linear-gradient(90deg,#5a8dee,#7aadff)}
.metric.green::before{background:linear-gradient(90deg,#38a169,#68c89a)}
.metric.red::before{background:linear-gradient(90deg,#e05252,#f08080)}
.metric.yellow::before{background:linear-gradient(90deg,#d97706,#f6ad55)}
.metric.purple::before{background:linear-gradient(90deg,#7c5cbf,#9b4dca)}
.metric-val{font-family:'JetBrains Mono',monospace;font-size:var(--fs-xl);font-weight:700}
.metric.blue .metric-val{color:var(--primary)}
.metric.green .metric-val{color:var(--green)}
.metric.red .metric-val{color:var(--red)}
.metric.yellow .metric-val{color:var(--yellow)}
.metric.purple .metric-val{color:var(--purple)}
.metric-lbl{font-size:var(--fs-xs);color:var(--text3);margin-top:3px;font-weight:500}
.metric-sub{font-size:var(--fs-xs);color:var(--text3);position:absolute;top:10px;right:9px}
.charts-row{display:flex;gap:6px;height:180px;flex-shrink:0}
.chart-card{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--shadow)}
.chart-card-head{padding:6px 12px;font-size:var(--fs-sm);font-weight:600;color:var(--text2);border-bottom:1px solid var(--border2);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.chart-card-body{flex:1;padding:4px;min-height:0}
.bottom{flex:1;display:flex;gap:6px;overflow:hidden;min-height:0}
.table-card{flex:2.5;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;overflow:hidden;box-shadow:var(--shadow);min-width:0}
.tools-card{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;overflow:hidden;box-shadow:var(--shadow)}
.card-head{padding:7px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border2);flex-shrink:0;font-size:var(--fs-base);font-weight:600;color:var(--text2);background:var(--surface2)}
.table-scroll{flex:1;overflow:auto}
.table-scroll::-webkit-scrollbar{width:4px;height:4px}
.table-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
table{width:100%;border-collapse:collapse;table-layout:auto;font-size:10px;white-space:nowrap}
th{position:sticky;top:0;background:var(--surface2);z-index:10;padding:5px 4px;text-align:right;color:var(--text3);border-bottom:1px solid var(--border);font-weight:700;font-size:9px;white-space:nowrap;letter-spacing:.2px;font-family:'JetBrains Mono',monospace}
th:first-child{text-align:left;position:sticky;left:0;z-index:11;background:var(--surface2)}
th.th-dti{background:var(--purple-dim);color:var(--purple)}
th.th-bonus{background:var(--bonus-dim);color:var(--bonus)}
td{padding:4px 4px;border-bottom:1px solid rgba(216,225,236,.4);text-align:right;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:10px;white-space:nowrap}
td:first-child{text-align:left;position:sticky;left:0;background:var(--surface);font-weight:600;font-size:10px;border-right:1px solid var(--border2);color:var(--text2);z-index:1}
tr:hover td{background:var(--surface2)!important}
tr.row-risk td{background:rgba(224,82,82,.04)!important}
tr.row-risk td:first-child{border-left:2px solid var(--red);background:rgba(224,82,82,.04)!important}
tr.row-prepay td{background:rgba(194,105,26,.04)!important}
tr.row-prepay td:first-child{border-left:2px solid var(--orange);background:rgba(194,105,26,.04)!important}
tr.row-rate td{background:rgba(90,141,238,.04)!important}
tr.row-rate td:first-child{border-left:2px solid var(--primary);background:rgba(90,141,238,.04)!important}
tr.row-bonus td{background:rgba(155,77,202,.05)!important}
tr.row-bonus td:first-child{border-left:2px solid var(--bonus);background:rgba(155,77,202,.05)!important}
th.grp-sep,td.grp-sep{border-left:1px solid var(--border)}
.dti-cell{font-weight:700}
.dti-safe{color:var(--green)}
.dti-warn{color:var(--yellow)}
.dti-high{color:var(--red)}
.dti-over{color:var(--purple)}
.val-pos{color:var(--green)}
.val-neg{color:var(--red)}
.val-blue{color:var(--primary)}
.val-cyan{color:var(--cyan)}
.val-orange{color:var(--orange)}
.val-bonus{color:var(--bonus)}
.val-dim{color:var(--text3)}
.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--surface2)}
.tab{flex:1;padding:7px 0;text-align:center;font-size:var(--fs-sm);font-weight:600;color:var(--text3);cursor:pointer;border-right:1px solid var(--border);transition:color .15s,background .15s}
.tab.active{color:var(--primary);background:var(--surface)}
.tab-panel{display:none;flex:1;overflow-y:auto;padding:8px;flex-direction:column;gap:5px}
.tab-panel.active{display:flex}
.tab-panel::-webkit-scrollbar{width:4px}
.tab-panel::-webkit-scrollbar-thumb{background:var(--border)}
.tool-section{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:9px}
.tool-section-head{font-size:var(--fs-xs);color:var(--text3);font-weight:700;letter-spacing:.5px;margin-bottom:7px}
.event-list{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);overflow-y:auto;max-height:105px}
.event-item{display:flex;justify-content:space-between;align-items:center;padding:5px 9px;border-bottom:1px solid var(--border2);font-size:var(--fs-sm)}
.event-item:last-child{border:none}
.event-date{color:var(--text3);font-family:'JetBrains Mono',monospace}
.event-val{font-weight:700;font-family:'JetBrains Mono',monospace}
.del-btn{color:var(--red);cursor:pointer;font-size:var(--fs-sm);opacity:.5;transition:opacity .1s;margin-left:6px;flex-shrink:0}
.del-btn:hover{opacity:1}
.btn-small{height:26px;padding:0 11px;border:none;border-radius:var(--radius-sm);font-size:var(--fs-sm);font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:4px;transition:opacity .15s}
.btn-add{background:var(--green-dim);color:var(--green);border:1px solid rgba(56,161,105,.3)}
.btn-export{background:var(--primary-dim);color:var(--primary);border:1px solid rgba(90,141,238,.3)}
.btn-nav{background:var(--surface2);color:var(--text3);border:1px solid var(--border);height:24px;padding:0 9px;border-radius:4px;cursor:pointer;font-size:var(--fs-sm)}
.btn-warn{background:var(--yellow-dim);color:var(--yellow);border:1px solid rgba(217,119,6,.3)}
.btn-bonus{background:var(--bonus-dim);color:var(--bonus);border:1px solid rgba(155,77,202,.3)}
.col-toggle-bar{display:flex;gap:4px;padding:4px 8px;border-bottom:1px solid var(--border2);background:var(--surface2);flex-wrap:wrap;align-items:center;flex-shrink:0}
.col-toggle-bar span{font-size:9px;color:var(--text3);font-weight:700;margin-right:2px}
.ctog{font-size:9px;padding:2px 6px;border-radius:3px;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text3);font-family:'JetBrains Mono',monospace;user-select:none}
.ctog.on{background:var(--primary-dim);color:var(--primary);border-color:rgba(90,141,238,.4);font-weight:700}
.report-block{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;margin-bottom:7px}
.rb-head{padding:6px 11px;font-size:var(--fs-sm);font-weight:700;display:flex;align-items:center;gap:5px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.6)}
.rb-body{padding:9px;font-size:var(--fs-sm)}
.dti-progress-row{display:flex;height:10px;border-radius:5px;overflow:hidden;margin:6px 0;background:var(--border)}
.dti-prog-safe{background:var(--green)}
.dti-prog-warn{background:var(--yellow)}
.dti-prog-high{background:var(--red)}
.stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin:6px 0}
.stat-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin:6px 0}
.stat-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin:6px 0}
.stat-cell{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:7px;text-align:center}
.stat-cell-val{font-family:'JetBrains Mono',monospace;font-size:var(--fs-lg);font-weight:700}
.stat-cell-lbl{font-size:var(--fs-xs);color:var(--text3);margin-top:3px;font-weight:500}
.stat-cell-sub{font-size:var(--fs-xs);color:var(--text3)}
.insight-row{display:flex;gap:6px;align-items:flex-start;padding:7px 8px;background:var(--surface);border-radius:var(--radius-sm);margin-bottom:5px;border:1px solid var(--border);border-left-width:3px;font-size:var(--fs-sm);line-height:1.6}
.insight-row.ok{border-left-color:var(--green)}
.insight-row.warn{border-left-color:var(--yellow)}
.insight-row.bad{border-left-color:var(--red)}
.insight-row.info{border-left-color:var(--primary)}
.insight-icon{flex-shrink:0;margin-top:1px}
.stress-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
.stress-cell{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:7px;text-align:center}
.stress-val{font-family:'JetBrains Mono',monospace;font-size:var(--fs-base);font-weight:700}
.stress-lbl{font-size:var(--fs-xs);color:var(--text3);margin-top:2px;font-weight:500}
.milestone-list{display:flex;flex-direction:column;gap:5px}
.milestone{display:flex;justify-content:space-between;align-items:center;padding:6px 9px;background:var(--surface);border-radius:var(--radius-sm);border:1px solid var(--border)}
.ms-label{font-size:var(--fs-sm);color:var(--text2)}
.ms-date{font-family:'JetBrains Mono',monospace;font-size:var(--fs-sm);font-weight:600}
.year-nav{display:flex;align-items:center;gap:6px}
.year-display{font-family:'JetBrains Mono',monospace;font-size:var(--fs-base);font-weight:700;color:var(--primary);min-width:44px;text-align:center}
.rate-type-row{display:flex;gap:4px;margin-bottom:6px}
.rate-type-btn{flex:1;text-align:center;padding:4px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:var(--fs-sm);cursor:pointer;color:var(--text3);background:var(--surface);transition:all .15s}
.rate-type-btn.active{background:var(--primary-dim);color:var(--primary);border-color:rgba(90,141,238,.4);font-weight:700}
.prepay-opts{display:flex;gap:4px;margin-bottom:6px}
.prepay-opt{flex:1;text-align:center;padding:4px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:var(--fs-sm);cursor:pointer;color:var(--text3);background:var(--surface);transition:all .15s}
.prepay-opt.active{background:var(--orange-dim);color:var(--orange);border-color:rgba(194,105,26,.4)}
.prepay-target-row{display:flex;gap:4px;margin-bottom:6px}
.prepay-target-btn{flex:1;text-align:center;padding:5px 4px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:var(--fs-sm);cursor:pointer;color:var(--text3);background:var(--surface);transition:all .15s;line-height:1.3}
.prepay-target-btn.act-com{background:var(--primary-dim);color:var(--primary);border-color:rgba(90,141,238,.4);font-weight:700}
.prepay-target-btn.act-fund{background:var(--cyan-dim);color:var(--cyan);border-color:rgba(43,143,163,.4);font-weight:700}
.prepay-target-btn.act-both{background:var(--green-dim);color:var(--green);border-color:rgba(56,161,105,.4);font-weight:700}
.ntag{display:inline-block;font-size:9px;padding:1px 4px;border-radius:3px;font-weight:700;margin-right:2px}
.ntag-prepay-com{background:var(--primary-dim);color:var(--primary)}
.ntag-prepay-fund{background:var(--cyan-dim);color:var(--cyan)}
.ntag-rate{background:var(--primary-dim);color:var(--primary)}
.ntag-pf{background:var(--green-dim);color:var(--green)}
.ntag-year{background:var(--yellow-dim);color:var(--yellow)}
.ntag-bonus{background:var(--bonus-dim);color:var(--bonus)}
.ntag-exp{background:var(--teal-dim);color:var(--teal)}
.legend-dots{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.legend-dot{display:flex;align-items:center;gap:3px;font-size:var(--fs-xs);color:var(--text3)}
.dot{width:8px;height:8px;border-radius:50%}
.formula{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 9px;font-family:'JetBrains Mono',monospace;font-size:var(--fs-xs);color:var(--text2);margin:5px 0}
.bonus-use-row{display:flex;gap:4px;margin-bottom:5px}
.bonus-use-btn{flex:1;text-align:center;padding:3px 2px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:var(--fs-xs);cursor:pointer;color:var(--text3);background:var(--surface);transition:all .15s;line-height:1.4;font-weight:600}
.bonus-use-btn.act-prepay{background:var(--bonus-dim);color:var(--bonus);border-color:rgba(155,77,202,.4);font-weight:700}
.bonus-use-btn.act-save{background:var(--green-dim);color:var(--green);border-color:rgba(56,161,105,.4);font-weight:700}
.bonus-use-btn.act-split{background:var(--yellow-dim);color:var(--yellow);border-color:rgba(217,119,6,.4);font-weight:700}
select.bonus-month-sel{background:var(--bonus-dim);border-color:rgba(155,77,202,.35);color:var(--bonus);font-weight:600}

/* â•â• é€å¹´å¹´ç»ˆå¥–äº‹ä»¶åˆ—è¡¨ â•â• */
.bonus-event-item{display:flex;align-items:center;padding:5px 9px;border-bottom:1px solid var(--border2);font-size:var(--fs-sm);gap:5px;flex-wrap:wrap}
.bonus-event-item:last-child{border:none}
.bonus-ev-year{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--bonus);flex-shrink:0;min-width:48px}
.bonus-ev-amt{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--orange);margin-right:4px}
.bonus-ev-use{font-size:9px;padding:1px 5px;border-radius:8px;font-weight:700;flex-shrink:0}
.bonus-ev-use.prepay{background:var(--bonus-dim);color:var(--bonus)}
.bonus-ev-use.save{background:var(--green-dim);color:var(--green)}
.bonus-ev-use.split{background:var(--yellow-dim);color:var(--yellow)}
.bonus-ev-tgt{font-size:9px;color:var(--text3)}
.yb-hint{font-size:9px;color:var(--text3);padding:4px 8px;background:var(--bonus-dim);border-radius:3px;margin-bottom:5px;line-height:1.5}
/* â•â• å¹´ç»ˆå¥–è¾“å…¥åŒº â•â• */
.yb-input-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:4px}
</style>
</head>
<body>
<div class="header">
  <div class="header-left">
    <div class="logo"><i class="fas fa-home"></i> æˆ¿è´·æ¨æ¼”ç³»ç»Ÿ</div>
    <div class="header-sub">v10.0 Â· é€å¹´å¹´ç»ˆå¥–å˜åŠ¨ Â· æ”¯å‡ºå˜åŠ¨ Â· ç²¾å‡†è®¡ç®—</div>
  </div>
  <div class="header-badges">
    <span class="badge badge-blue"><i class="fas fa-percentage"></i> é€æœˆDTI</span>
    <span class="badge badge-green"><i class="fas fa-chart-line"></i> æ”¶å…¥å¢é•¿</span>
    <span class="badge badge-purple"><i class="fas fa-flask"></i> å‹åŠ›æµ‹è¯•</span>
    <span class="badge badge-bonus"><i class="fas fa-gift"></i> é€å¹´å¹´ç»ˆå¥–</span>
    <span class="badge badge-teal"><i class="fas fa-wallet"></i> æ”¯å‡ºå˜åŠ¨</span>
  </div>
</div>

<div class="layout">
  <div class="sidebar">
    <div class="sidebar-inner">
      <!-- æ”¶æ”¯åŸºç¡€ -->
      <div>
        <div class="s-head"><i class="fas fa-calendar"></i> æ”¶æ”¯åŸºç¡€</div>
        <div class="field-group">
          <div class="field"><label>å¼€å§‹æœˆä»½</label><input type="month" id="startDate"></div>
          <div class="field">
            <label>è´·æ¬¾ç»„åˆ</label>
            <select id="loanType" onchange="toggleInputs()">
              <option value="combined">ç»„åˆè´·</option>
              <option value="commercial">ä»…å•†è´·</option>
              <option value="fund">ä»…å…¬ç§¯é‡‘</option>
            </select>
          </div>
        </div>
        <div class="field-group">
          <div class="field"><label>å®¶åº­æœˆæ”¶å…¥</label><div class="input-wrap"><input type="number" id="income" value="25000"><span class="input-unit">å…ƒ</span></div></div>
          <div class="field"><label>å›ºå®šæœˆæ”¯å‡º</label><div class="input-wrap"><input type="number" id="expenses" value="6000"><span class="input-unit">å…ƒ</span></div></div>
        </div>
        <div class="field-group">
          <div class="field"><label>å¹´æ”¶å…¥å¢é€Ÿ</label><div class="input-wrap"><input type="number" id="incomeGrowth" value="0" step="0.1" min="0" max="20"><span class="input-unit">%</span></div></div>
          <div class="field"><label>æ”¯å‡ºå¹´å¢é€Ÿ</label><div class="input-wrap"><input type="number" id="expGrowth" value="0" step="0.1" min="0" max="20"><span class="input-unit">%</span></div></div>
        </div>
      </div>

      <!-- å¹´ç»ˆå¥–åŸºç¡€è®¾ç½® -->
      <div class="loan-box bonus-box">
        <div class="s-head" style="color:var(--bonus)"><i class="fas fa-gift"></i> å¹´ç»ˆå¥–é»˜è®¤è®¾ç½®</div>
        <div class="field-group">
          <div class="field"><label>é¦–æ¬¡å‘æ”¾å¹´ä»½</label><input type="number" id="bonusYear" placeholder="å¦‚2025"></div>
          <div class="field"><label>é»˜è®¤é‡‘é¢</label><div class="input-wrap"><input type="number" id="bonusAmt" value="0" step="0.1"><span class="input-unit">ä¸‡</span></div></div>
        </div>
        <div class="field-group">
          <div class="field">
            <label>å‘æ”¾æœˆä»½</label>
            <select id="bonusMonth" class="bonus-month-sel">
              <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
              <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
              <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
              <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12" selected>12æœˆ</option>
            </select>
          </div>
          <div class="field"><label>é»˜è®¤å¹´å¢é€Ÿ</label><div class="input-wrap"><input type="number" id="bonusGrowth" value="0" step="0.1"><span class="input-unit">%</span></div></div>
        </div>
        <div style="margin-bottom:4px">
          <label style="margin-bottom:3px;display:block">é»˜è®¤ç”¨é€”ç­–ç•¥</label>
          <div class="bonus-use-row">
            <div class="bonus-use-btn act-prepay" id="bonusUse-prepay" onclick="selBonusUse('prepay')">ğŸš€ å…¨é¢æå‰è¿˜</div>
            <div class="bonus-use-btn" id="bonusUse-save" onclick="selBonusUse('save')">ğŸ’° å…¨é¢å‚¨è“„</div>
            <div class="bonus-use-btn" id="bonusUse-split" onclick="selBonusUse('split')">âš–ï¸ éƒ¨åˆ†è¿˜æ¬¾</div>
          </div>
        </div>
        <div id="bonusSplitGroup" style="display:none" class="field-group">
          <div class="field"><label>é»˜è®¤è¿˜æ¬¾æ¯”ä¾‹</label><div class="input-wrap"><input type="number" id="bonusSplitRatio" value="50" min="0" max="100"><span class="input-unit">%</span></div></div>
          <div class="field">
            <label>è¿˜æ¬¾å¯¹è±¡</label>
            <select id="bonusSplitTarget"><option value="com">å•†è´·</option><option value="fund">å…¬ç§¯é‡‘</option><option value="both">æŒ‰æ¯”ä¾‹</option></select>
          </div>
        </div>
        <div id="bonusPrepayGroup">
          <label style="margin-bottom:2px;display:block">é»˜è®¤è¿˜æ¬¾å¯¹è±¡</label>
          <select id="bonusPrepayTarget">
            <option value="com">å•†è´·</option><option value="fund">å…¬ç§¯é‡‘</option><option value="both">æŒ‰æ¯”ä¾‹</option>
          </select>
        </div>
      </div>

      <!-- å•†ä¸šè´·æ¬¾ -->
      <div id="box-com" class="loan-box com">
        <div class="s-head" style="color:var(--primary)"><i class="fas fa-building"></i> å•†ä¸šè´·æ¬¾</div>
        <div class="field-group">
          <div class="field"><label>æ€»é¢</label><div class="input-wrap"><input type="number" id="cAmt" value="100"><span class="input-unit">ä¸‡</span></div></div>
          <div class="field"><label>åˆ©ç‡</label><div class="input-wrap"><input type="number" id="cRate" value="3.2" step="0.01"><span class="input-unit">%</span></div></div>
        </div>
        <div class="field-group">
          <div class="field"><label>å¹´é™</label><div class="input-wrap"><input type="number" id="cYear" value="30"><span class="input-unit">å¹´</span></div></div>
          <div class="field"><label>æ–¹å¼</label><select id="cMethod"><option value="1">ç­‰é¢æœ¬æ¯</option><option value="2">ç­‰é¢æœ¬é‡‘</option></select></div>
        </div>
      </div>

      <!-- å…¬ç§¯é‡‘ -->
      <div id="box-fund" class="loan-box fund">
        <div class="s-head" style="color:var(--cyan)"><i class="fas fa-landmark"></i> å…¬ç§¯é‡‘è´·æ¬¾</div>
        <div class="field-group">
          <div class="field"><label>æ€»é¢</label><div class="input-wrap"><input type="number" id="fAmt" value="60"><span class="input-unit">ä¸‡</span></div></div>
          <div class="field"><label>åˆ©ç‡</label><div class="input-wrap"><input type="number" id="fRate" value="2.85" step="0.01"><span class="input-unit">%</span></div></div>
        </div>
        <div class="field-group">
          <div class="field"><label>å¹´é™</label><div class="input-wrap"><input type="number" id="fYear" value="30"><span class="input-unit">å¹´</span></div></div>
          <div class="field"><label>æ–¹å¼</label><select id="fMethod"><option value="1">ç­‰é¢æœ¬æ¯</option><option value="2">ç­‰é¢æœ¬é‡‘</option></select></div>
        </div>
      </div>

      <!-- å…¬ç§¯é‡‘å¯¹å†² -->
      <div>
        <div class="s-head"><i class="fas fa-piggy-bank"></i> å…¬ç§¯é‡‘å¯¹å†²</div>
        <div class="field-group">
          <div class="field"><label>è´¦æˆ·ä½™é¢</label><div class="input-wrap"><input type="number" id="pfBal" value="40000"><span class="input-unit">å…ƒ</span></div></div>
          <div class="field"><label>æœˆç¼´ï¼ˆåŒè¾¹ï¼‰</label><div class="input-wrap"><input type="number" id="pfAdd" value="3000"><span class="input-unit">å…ƒ</span></div></div>
        </div>
        <div class="field-group">
          <div class="field">
            <label>å¯¹å†²ç­–ç•¥</label>
            <select id="pfMode" onchange="togglePfDate()">
              <option value="month">æ¯æœˆæŠµæ‰£</option>
              <option value="year">å¹´åº¦å†²æŠµ(1æœˆ)</option>
              <option value="none">ä¸ä½¿ç”¨</option>
            </select>
          </div>
          <div class="field" id="pfDateGroup">
            <label>å¼€å§‹æ—¶é—´</label>
            <input type="month" id="pfStartDate">
          </div>
        </div>
      </div>

      <!-- æå‰è¿˜æ¬¾é€‰é¡¹ -->
      <div>
        <div class="s-head"><i class="fas fa-sliders-h"></i> æå‰è¿˜æ¬¾æ–¹å¼</div>
        <div class="prepay-opts">
          <div class="prepay-opt active" id="opt-term" onclick="selPrepayOpt('term')">ç¼©çŸ­å¹´é™</div>
          <div class="prepay-opt" id="opt-amt" onclick="selPrepayOpt('amt')">å‡å°‘æœˆä¾›</div>
        </div>
      </div>

      <button class="calc-btn" onclick="doCalc()">
        <i class="fas fa-calculator"></i> æ‰§è¡Œæ¨æ¼”
      </button>
    </div>
  </div>

  <div class="main">
    <!-- KPI -->
    <div class="metrics">
      <div class="metric blue"><div class="metric-sub">æ€»æˆæœ¬</div><div class="metric-val" id="kpi-int">0</div><div class="metric-lbl">æ€»åˆ©æ¯ (ä¸‡å…ƒ)</div></div>
      <div class="metric red"><div class="metric-sub">åˆ©æ¯ç‡</div><div class="metric-val" id="kpi-ratio">0%</div><div class="metric-lbl">åˆ©æ¯/æœ¬é‡‘æ¯”</div></div>
      <div class="metric green"><div class="metric-sub">è´¢å¯Œ</div><div class="metric-val" id="kpi-net">0</div><div class="metric-lbl">æœŸæœ«å‡€å‚¨è“„ (ä¸‡å…ƒ)</div></div>
      <div class="metric yellow"><div class="metric-sub">DTI</div><div class="metric-val" id="kpi-dti">0%</div><div class="metric-lbl">åˆå§‹ç°é‡‘DTI</div></div>
      <div class="metric purple"><div class="metric-sub">é‡Œç¨‹ç¢‘</div><div class="metric-val" id="kpi-date" style="font-size:14px">--</div><div class="metric-lbl">é¢„è®¡ä¸Šå²¸æ—¥</div></div>
    </div>

    <!-- å›¾è¡¨ -->
    <div class="charts-row">
      <div class="chart-card" style="flex:1.4">
        <div class="chart-card-head">
          <span>èµ„äº§ vs è´Ÿå€º èµ›è·‘</span>
          <div class="legend-dots">
            <div class="legend-dot"><div class="dot" style="background:var(--green)"></div>å‡€å‚¨è“„</div>
            <div class="legend-dot"><div class="dot" style="background:var(--red)"></div>å‰©ä½™å€ºåŠ¡</div>
            <div class="legend-dot"><div class="dot" style="background:var(--bonus)"></div>å¹´ç»ˆå¥–ç´¯è®¡</div>
          </div>
        </div>
        <div class="chart-card-body"><canvas id="chartRace"></canvas></div>
      </div>
      <div class="chart-card" style="flex:1.4">
        <div class="chart-card-head">
          <span>é€æœˆ DTI èµ°åŠ¿</span>
          <div class="legend-dots">
            <div class="legend-dot"><div class="dot" style="background:var(--purple)"></div>ç°é‡‘DTI</div>
            <div class="legend-dot"><div class="dot" style="background:var(--yellow)"></div>æ€»DTI</div>
          </div>
        </div>
        <div class="chart-card-body"><canvas id="chartDTI"></canvas></div>
      </div>
      <div class="chart-card" style="flex:1">
        <div class="chart-card-head"><span>æœ¬æ¯ç»“æ„ï¼ˆç´¯è®¡ï¼‰</span></div>
        <div class="chart-card-body"><canvas id="chartPie"></canvas></div>
      </div>
    </div>

    <!-- åº•éƒ¨ï¼šè¡¨æ ¼ + å·¥å…· -->
    <div class="bottom">
      <div class="table-card">
        <div class="card-head">
          <div>
            æ˜ç»†æµæ°´
            <span style="font-size:var(--fs-xs);color:var(--text3)">
              Â· å…ƒ Â·
              <span style="color:var(--green)">å®‰å…¨</span>
              <span style="color:var(--yellow)">è­¦å‘Š</span>
              <span style="color:var(--red)">è¶…æ ‡/è´Ÿç»“ä½™</span>
              <span style="color:var(--bonus)">å¹´ç»ˆå¥–</span>
            </span>
          </div>
          <div class="year-nav">
            <button class="btn-nav" onclick="changeYear(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="year-display" id="dispYear">--</div>
            <button class="btn-nav" onclick="changeYear(1)"><i class="fas fa-chevron-right"></i></button>
            <button class="btn-small btn-export" style="margin-left:5px" onclick="exportExcel()"><i class="fas fa-download"></i> å¯¼å‡º</button>
          </div>
        </div>
        <div class="col-toggle-bar">
          <span>åˆ—ç»„ï¼š</span>
          <div class="ctog on" id="tog-base" onclick="toggleCols('base')">åŸºç¡€</div>
          <div class="ctog on" id="tog-dti" onclick="toggleCols('dti')">DTI</div>
          <div class="ctog on" id="tog-com" onclick="toggleCols('com')">å•†è´·</div>
          <div class="ctog on" id="tog-fund" onclick="toggleCols('fund')">å…¬è´·</div>
          <div class="ctog on" id="tog-prepay" onclick="toggleCols('prepay')">æå‰è¿˜</div>
          <div class="ctog on" id="tog-bonus" onclick="toggleCols('bonus')">å¹´ç»ˆå¥–</div>
        </div>
        <div class="table-scroll">
          <table id="flowTable">
            <thead id="tableHead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- å³ä¾§å·¥å…·é¢æ¿ -->
      <div class="tools-card">
        <div class="tabs">
          <div class="tab active" id="tab-report" onclick="switchTab('report')"><i class="fas fa-brain"></i> æ™ºèƒ½åˆ†æ</div>
          <div class="tab" id="tab-pay" onclick="switchTab('pay')"><i class="fas fa-coins"></i> æå‰è¿˜æ¬¾</div>
          <div class="tab" id="tab-other" onclick="switchTab('other')"><i class="fas fa-sliders-h"></i> å˜åŠ¨</div>
        </div>

        <!-- æ™ºèƒ½åˆ†æ -->
        <div id="panel-report" class="tab-panel active">
          <div id="reportContent"></div>
        </div>

        <!-- æå‰è¿˜æ¬¾ -->
        <div id="panel-pay" class="tab-panel">
          <div class="tool-section">
            <div class="tool-section-head"><i class="fas fa-magic"></i> æ‰¹é‡å®šæœŸè¿˜æ¬¾</div>
            <label style="margin-bottom:5px;display:block">è¿˜æ¬¾å¯¹è±¡</label>
            <div class="prepay-target-row" id="regTargetRow">
              <div class="prepay-target-btn act-com" id="regTgt-com" onclick="selRegTarget('com')"><i class="fas fa-building"></i> å•†è´·</div>
              <div class="prepay-target-btn" id="regTgt-fund" onclick="selRegTarget('fund')"><i class="fas fa-landmark"></i> å…¬ç§¯é‡‘</div>
              <div class="prepay-target-btn" id="regTgt-both" onclick="selRegTarget('both')"><i class="fas fa-balance-scale"></i> æŒ‰æ¯”ä¾‹</div>
            </div>
            <div class="field-group">
              <div class="field"><label>é¦–æ¬¡æ—¶é—´</label><input type="month" id="regStart"></div>
              <div class="field"><label>é—´éš”æœˆ</label><input type="number" id="regInterval" value="12" min="1"></div>
            </div>
            <div class="field-group">
              <div class="field"><label>æ¯æ¬¡é‡‘é¢(ä¸‡)</label><input type="number" id="regAmt" value="5" step="0.1"></div>
              <div class="field"><label>å…±å‡ æ¬¡</label><input type="number" id="regTimes" value="5" min="1"></div>
            </div>
            <button class="btn-small btn-add" onclick="genRegular()" style="width:100%">
              <i class="fas fa-bolt"></i> ä¸€é”®ç”Ÿæˆå®šæœŸè¿˜æ¬¾è®¡åˆ’
            </button>
          </div>
          <div class="tool-section">
            <div class="tool-section-head"><i class="fas fa-plus-circle"></i> å•ç¬”æ·»åŠ </div>
            <label style="margin-bottom:5px;display:block">è¿˜æ¬¾å¯¹è±¡</label>
            <div class="prepay-target-row" id="singleTargetRow">
              <div class="prepay-target-btn act-com" id="singleTgt-com" onclick="selSingleTarget('com')"><i class="fas fa-building"></i> å•†è´·</div>
              <div class="prepay-target-btn" id="singleTgt-fund" onclick="selSingleTarget('fund')"><i class="fas fa-landmark"></i> å…¬ç§¯é‡‘</div>
              <div class="prepay-target-btn" id="singleTgt-both" onclick="selSingleTarget('both')"><i class="fas fa-balance-scale"></i> æŒ‰æ¯”ä¾‹</div>
            </div>
            <div class="field-group">
              <div class="field"><label>æ—¶é—´</label><input type="month" id="pyDate"></div>
              <div class="field"><label>é‡‘é¢(ä¸‡)</label><input type="number" id="pyAmt" step="0.1"></div>
            </div>
            <div style="display:flex;gap:5px;align-items:center">
              <span style="font-size:var(--fs-sm);color:var(--text3)">å·²æ·»åŠ  <span id="payCount" style="color:var(--orange);font-weight:700">0</span> ç¬”</span>
              <button class="btn-small btn-add" onclick="addPay()" style="margin-left:auto"><i class="fas fa-plus"></i> æ·»åŠ </button>
            </div>
          </div>
          <div class="event-list" id="list-pay"></div>
        </div>

        <!-- å˜åŠ¨ -->
        <div id="panel-other" class="tab-panel">

          <!-- é€å¹´å¹´ç»ˆå¥–ä¸ªæ€§åŒ–ï¼ˆäº‹ä»¶å¼ï¼‰-->
          <div class="tool-section">
            <div class="tool-section-head"><i class="fas fa-gift"></i> é€å¹´å¹´ç»ˆå¥–ä¸ªæ€§åŒ– <span style="color:var(--bonus);font-size:10px">â—</span></div>

            <div class="yb-input-grid">
              <div class="field"><label>å¹´ä»½</label><input type="number" id="ybYear" placeholder="å¦‚2026" min="2026" max="2060"></div>
              <div class="field"><label>é‡‘é¢(ä¸‡ï¼Œç•™ç©º=é»˜è®¤)</label><input type="number" id="ybAmt" step="0.1" placeholder="ç•™ç©ºç”¨é»˜è®¤"></div>
            </div>
            <div style="margin-bottom:4px">
              <div class="bonus-use-row">
                <div class="bonus-use-btn" id="ybUse-default" onclick="selYbUse('default')">é»˜è®¤</div>
                <div class="bonus-use-btn" id="ybUse-prepay" onclick="selYbUse('prepay')">ğŸš€ å…¨è¿˜</div>
                <div class="bonus-use-btn" id="ybUse-save" onclick="selYbUse('save')">ğŸ’° å…¨å­˜</div>
                <div class="bonus-use-btn" id="ybUse-split" onclick="selYbUse('split')">âš–ï¸ åˆ†é…</div>
              </div>
            </div>
            <div id="ybSplitRow" style="display:none" class="field-group">
              <div class="field"><label>è¿˜æ¬¾æ¯”ä¾‹</label><div class="input-wrap"><input type="number" id="ybSplitRatio" value="50" min="0" max="100"><span class="input-unit">%</span></div></div>
              <div class="field"><label>è¿˜æ¬¾å¯¹è±¡</label><select id="ybSplitTgt"><option value="com">å•†è´·</option><option value="fund">å…¬ç§¯é‡‘</option><option value="both">æŒ‰æ¯”ä¾‹</option></select></div>
            </div>
            <div id="ybPrepayRow" class="field" style="display:none;margin-bottom:4px">
              <label>è¿˜æ¬¾å¯¹è±¡</label>
              <select id="ybPrepayTgt"><option value="com">å•†è´·</option><option value="fund">å…¬ç§¯é‡‘</option><option value="both">æŒ‰æ¯”ä¾‹</option></select>
            </div>
            <button class="btn-small btn-bonus" style="width:100%" onclick="addYbEvent()">
              <i class="fas fa-plus"></i> æ·»åŠ è¯¥å¹´ä»½ä¸ªæ€§åŒ–è®¾ç½®
            </button>
            <div class="event-list" style="margin-top:6px;max-height:120px" id="list-yb"></div>
          </div>

          <!-- åˆ©ç‡å˜åŠ¨ -->
          <div class="tool-section">
            <div class="tool-section-head"><i class="fas fa-percentage"></i> åˆ©ç‡å˜åŠ¨<span style="color:var(--primary);font-size:10px">â—</span></div>
            <div class="rate-type-row">
              <div class="rate-type-btn active" id="rateTypeCom" onclick="selRateType('com')"><i class="fas fa-building"></i> å•†è´·</div>
              <div class="rate-type-btn" id="rateTypeFund" onclick="selRateType('fund')"><i class="fas fa-landmark"></i> å…¬è´·</div>
            </div>
            <div class="field-group">
              <div class="field"><label>ç”Ÿæ•ˆæ—¶é—´</label><input type="month" id="rtDate"></div>
              <div class="field"><label>æ–°åˆ©ç‡(%)</label><input type="number" id="rtVal" step="0.01"></div>
              <button class="btn-small btn-add" onclick="addEv('rate')" style="align-self:flex-end"><i class="fas fa-plus"></i>æ·»åŠ </button>
            </div>
            <div class="event-list" id="list-rate" style="max-height:75px"></div>
          </div>

          <!-- å›ºå®šæ”¯å‡ºå˜åŠ¨ -->
          <div class="tool-section">
            <div class="tool-section-head"><i class="fas fa-wallet"></i> å›ºå®šæ”¯å‡ºå˜åŠ¨<span style="color:var(--primary);font-size:10px">â—</span></div>
            <div style="font-size:var(--fs-xs);color:var(--text3);margin-bottom:5px">åœ¨ç‰¹å®šæ—¶é—´ç‚¹ä¿®æ”¹å®¶åº­æœˆå›ºå®šæ”¯å‡º</div>
            <div class="field-group">
              <div class="field"><label>ç”Ÿæ•ˆæ—¶é—´</label><input type="month" id="expChDate"></div>
              <div class="field"><label>æ–°æœˆæ”¯å‡º(å…ƒ)</label><input type="number" id="expChVal"></div>
              <button class="btn-small btn-add" onclick="addEv('exp')" style="align-self:flex-end"><i class="fas fa-plus"></i>æ·»åŠ </button>
            </div>
            <div class="event-list" id="list-exp" style="max-height:75px"></div>
          </div>

          <!-- å…¬ç§¯é‡‘æœˆç¼´å˜åŠ¨ -->
          <div class="tool-section">
            <div class="tool-section-head"><i class="fas fa-piggy-bank"></i> å…¬ç§¯é‡‘æœˆç¼´å˜åŠ¨<span style="color:var(00ffss);font-size:10px">â—</span></div>
            <div class="field-group">
              <div class="field"><label>ç”Ÿæ•ˆæ—¶é—´</label><input type="month" id="pfChDate"></div>
              <div class="field"><label>æ–°æœˆç¼´(å…ƒ)</label><input type="number" id="pfChVal"></div>
              <button class="btn-small btn-add" onclick="addEv('pf')" style="align-self:flex-end"><i class="fas fa-plus"></i>æ·»åŠ </button>
            </div>
            <div class="event-list" id="list-pf" style="max-height:75px"></div>
          </div>

          <!-- æ”¶å…¥é˜¶æ®µæ€§è·³æ¶¨ -->
          <div class="tool-section">
            <div class="tool-section-head"><i class="fas fa-user-tie"></i> æ”¶å…¥é˜¶æ®µæ€§è·³æ¶¨<span style="color:var(--bonus);font-size:10px">â—</span></div>
            <div style="font-size:var(--fs-xs);color:var(--text3);margin-bottom:6px">åœ¨ç‰¹å®šæ—¶é—´ç‚¹è®¾ç½®æ–°æœˆæ”¶å…¥ï¼ˆè¦†ç›–å¢é€Ÿå…¬å¼ï¼‰</div>
            <div class="field-group">
              <div class="field"><label>æ—¶é—´</label><input type="month" id="incDate"></div>
              <div class="field"><label>æ–°æœˆæ”¶å…¥(å…ƒ)</label><input type="number" id="incVal"></div>
              <button class="btn-small btn-add" onclick="addEv('inc')" style="align-self:flex-end"><i class="fas fa-plus"></i>æ·»åŠ </button>
            </div>
            <div class="event-list" id="list-inc" style="max-height:75px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨å±€çŠ¶æ€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// events.yb: { year: Number, amt: Number|null, use: 'default'|'prepay'|'save'|'split', splitRatio: Number|null, splitTgt: str, prepayTgt: str }
let events = { pay:[], rate:[], pf:[], inc:[], exp:[], yb:[] };
let fullData = [];
let curViewYear = 0;
let chartRace = null, chartDTI = null, chartPie = null;
let currentRateType = 'com';
let prepayOption = 'term';
let singleTarget = 'com';
let regTarget = 'com';
let bonusUseMode = 'prepay';
let ybUseMode = 'default'; // for the input form
let colGroups = { base:true, dti:true, com:true, fund:true, prepay:true, bonus:true };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆ—å®šä¹‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COL_DEFS = [
  {key:'month',      group:'base',   label:'æœˆä»½'},
  {key:'inc',        group:'base',   label:'æ”¶å…¥'},
  {key:'exp',        group:'base',   label:'å›ºæ”¯'},
  {key:'totalPay',   group:'base',   label:'æœˆä¾›æ€»'},
  {key:'cashPay',    group:'base',   label:'ç°é‡‘ä¾›'},
  {key:'cover',      group:'base',   label:'å…¬ç§¯é‡‘å†²'},
  {key:'savingFlow', group:'base',   label:'æœˆå‡€ç»“ä½™'},
  {key:'cumSaving',  group:'base',   label:'ç´¯è®¡å‡€å‚¨è“„'},
  {key:'dtiCash',    group:'dti',    label:'ç°é‡‘DTI', thCls:'th-dti', grpSep:true},
  {key:'dtiTotal',   group:'dti',    label:'æ€»DTI',   thCls:'th-dti'},
  {key:'comPay',     group:'com',    label:'å•†æœˆä¾›',  grpSep:true},
  {key:'comPrin',    group:'com',    label:'å•†æœ¬'},
  {key:'comInt',     group:'com',    label:'å•†æ¯'},
  {key:'remC',       group:'com',    label:'å•†ä½™é¢'},
  {key:'fundPay',    group:'fund',   label:'å…¬æœˆä¾›',  grpSep:true},
  {key:'fundPrin',   group:'fund',   label:'å…¬æœ¬'},
  {key:'fundInt',    group:'fund',   label:'å…¬æ¯'},
  {key:'remF',       group:'fund',   label:'å…¬ä½™é¢'},
  {key:'extraCom',   group:'prepay', label:'å•†æè¿˜',  grpSep:true},
  {key:'extraFund',  group:'prepay', label:'å…¬æè¿˜'},
  {key:'bonus',      group:'bonus',  label:'å¹´ç»ˆå¥–',  grpSep:true, thCls:'th-bonus'},
  {key:'bonusPrepay',group:'bonus',  label:'å¥–-è¿˜æ¬¾'},
  {key:'bonusSave',  group:'bonus',  label:'å¥–-å‚¨è“„'},
  {key:'notes',      group:'base',   label:'å¤‡æ³¨'},
];
function visibleCols(){ return COL_DEFS.filter(c=>colGroups[c.group]); }
function toggleCols(grp){
  colGroups[grp]=!colGroups[grp];
  document.getElementById('tog-'+grp).classList.toggle('on',colGroups[grp]);
  renderTableHeader(); renderTable();
}
function renderTableHeader(){
  const cols=visibleCols();
  const tr=document.createElement('tr');
  cols.forEach((c,i)=>{
    const th=document.createElement('th');
    th.textContent=c.label;
    if(c.thCls) th.classList.add(c.thCls);
    const prevGrp=i>0?cols[i-1].group:null;
    if(c.grpSep&&prevGrp&&prevGrp!==c.group) th.classList.add('grp-sep');
    tr.appendChild(th);
  });
  const thead=document.getElementById('tableHead');
  thead.innerHTML='';
  thead.appendChild(tr);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload=()=>{
  const now=new Date();
  const nm=`${now.getFullYear()}-${String(now.getMonth()+2).padStart(2,'0')}`;
  if(!loadSettings()){
    document.getElementById('startDate').value=nm;
    document.getElementById('pfStartDate').value=nm;
    document.getElementById('regStart').value=nm;
    document.getElementById('bonusYear').value=now.getFullYear();
  }
  toggleInputs(); togglePfDate();
  renderTableHeader();
  selYbUse('default');
  doCalc();
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI è¾…åŠ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(id){
  ['report','pay','other'].forEach(t=>{
    document.getElementById('tab-'+t).classList.toggle('active',t===id);
    document.getElementById('panel-'+t).classList.toggle('active',t===id);
  });
}
function toggleInputs(){
  const t=document.getElementById('loanType').value;
  document.getElementById('box-com').style.display=(t==='combined'||t==='commercial')?'block':'none';
  document.getElementById('box-fund').style.display=(t==='combined'||t==='fund')?'block':'none';
}
function togglePfDate(){
  document.getElementById('pfDateGroup').style.visibility=document.getElementById('pfMode').value==='none'?'hidden':'visible';
}
function selPrepayOpt(v){ prepayOption=v; document.getElementById('opt-term').classList.toggle('active',v==='term'); document.getElementById('opt-amt').classList.toggle('active',v==='amt'); }
function selRateType(v){ currentRateType=v; document.getElementById('rateTypeCom').classList.toggle('active',v==='com'); document.getElementById('rateTypeFund').classList.toggle('active',v==='fund'); }
function changeYear(d){ if(!fullData.length) return; const min=fullData[0].y,max=fullData[fullData.length-1].y; curViewYear=Math.max(min,Math.min(max,curViewYear+d)); renderTable(); }
function selSingleTarget(v){ singleTarget=v; ['com','fund','both'].forEach(t=>{ document.getElementById('singleTgt-'+t).className='prepay-target-btn'+(t===v?` act-${v}`:''); }); }
function selRegTarget(v){ regTarget=v; ['com','fund','both'].forEach(t=>{ document.getElementById('regTgt-'+t).className='prepay-target-btn'+(t===v?` act-${v}`:''); }); }
function selBonusUse(v){
  bonusUseMode=v;
  ['prepay','save','split'].forEach(t=>{ document.getElementById('bonusUse-'+t).className='bonus-use-btn'+(t===v?` act-${t}`:''); });
  document.getElementById('bonusSplitGroup').style.display=v==='split'?'flex':'none';
  document.getElementById('bonusPrepayGroup').style.display=v==='prepay'?'block':'none';
  doCalc();
}
function selYbUse(v){
  ybUseMode=v;
  ['default','prepay','save','split'].forEach(t=>{ 
    const el=document.getElementById('ybUse-'+t); 
    if(!el) return;
    el.className='bonus-use-btn'+(t===v&&v!=='default'?` act-${t}`:t===v&&v==='default'?' act-save':'');
  });
  document.getElementById('ybSplitRow').style.display=v==='split'?'flex':'none';
  document.getElementById('ybPrepayRow').style.display=v==='prepay'?'block':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é€å¹´å¹´ç»ˆå¥–äº‹ä»¶ç®¡ç†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addYbEvent(){
  const yr=parseInt(document.getElementById('ybYear').value);
  if(!yr||yr<2025||yr>2080){ alert('è¯·å¡«å†™æœ‰æ•ˆå¹´ä»½'); return; }
  const amtRaw=document.getElementById('ybAmt').value;
  const amt=(amtRaw!==''&&amtRaw!==null)?parseFloat(amtRaw):null;
  const use=ybUseMode;
  const splitRatioRaw=document.getElementById('ybSplitRatio').value;
  const splitRatio=use==='split'?(splitRatioRaw!==''?parseFloat(splitRatioRaw):50):null;
  const splitTgt=document.getElementById('ybSplitTgt').value||'com';
  const prepayTgt=document.getElementById('ybPrepayTgt').value||'com';
  // æ›¿æ¢å·²å­˜åœ¨åŒå¹´
  const idx=events.yb.findIndex(e=>e.year===yr);
  const ev={year:yr,amt:(!isNaN(amt)&&amt!==null)?amt:null,use,splitRatio,splitTgt,prepayTgt};
  if(idx>=0) events.yb[idx]=ev; else events.yb.push(ev);
  events.yb.sort((a,b)=>a.year-b.year);
  renderYbList();
  doCalc();
}
function delYbEvent(i){ events.yb.splice(i,1); renderYbList(); doCalc(); }
function renderYbList(){
  const el=document.getElementById('list-yb');
  if(!events.yb.length){ el.innerHTML='<div class="event-item" style="color:var(--text3)</div>'; return; }
  const useLabels={default:'é»˜è®¤',prepay:'å…¨è¿˜',save:'å…¨å­˜',split:'åˆ†é…'};
  const useCls={default:'',prepay:'prepay',save:'save',split:'split'};
  el.innerHTML=events.yb.map((e,i)=>{
    const amtStr=e.amt!==null?`<span class="bonus-ev-amt">${e.amt}ä¸‡</span>`:'<span style="color:var(--text3);font-size:9px">é»˜è®¤é‡‘é¢</span>';
    const useStr=e.use!=='default'?`<span class="bonus-ev-use ${useCls[e.use]}">${useLabels[e.use]}</span>`:'<span class="bonus-ev-use" style="background:var(--surface3);color:var(--text3)">é»˜è®¤ç­–ç•¥</span>';
    let tgtStr='';
    if(e.use==='split') tgtStr=`<span class="bonus-ev-tgt">${e.splitRatio||50}%â†’${e.splitTgt==='com'?'å•†':e.splitTgt==='fund'?'å…¬':'æ¯”'}</span>`;
    else if(e.use==='prepay') tgtStr=`<span class="bonus-ev-tgt">â†’${e.prepayTgt==='com'?'å•†':e.prepayTgt==='fund'?'å…¬':'æ¯”'}</span>`;
    return `<div class="bonus-event-item"><span class="bonus-ev-year">${e.year}å¹´</span>${amtStr}${useStr}${tgtStr}<span class="del-btn" onclick="delYbEvent(${i})"><i class="fas fa-times"></i></span></div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é€šç”¨äº‹ä»¶ç®¡ç†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addPay(){
  const d=document.getElementById('pyDate').value;
  const v=parseFloat(document.getElementById('pyAmt').value)*10000;
  const tgt=singleTarget;
  if(!d||isNaN(v)||v<=0) return;
  const ex=events.pay.find(e=>e.date===d&&e.target===tgt);
  if(ex) ex.val+=v; else events.pay.push({date:d,val:v,target:tgt});
  renderList('pay'); doCalc();
}
function genRegular(){
  const start=document.getElementById('regStart').value;
  const interval=parseInt(document.getElementById('regInterval').value)||12;
  const amt=parseFloat(document.getElementById('regAmt').value)||0;
  const times=parseInt(document.getElementById('regTimes').value)||0;
  const tgt=regTarget;
  if(!start||amt<=0||times<=0){alert('è¯·å¡«å†™å®Œæ•´å‚æ•°');return;}
  let d=new Date(start);
  for(let i=0;i<times;i++){
    const ds=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const ex=events.pay.find(e=>e.date===ds&&e.target===tgt);
    if(ex) ex.val+=amt*10000; else events.pay.push({date:ds,val:amt*10000,target:tgt});
    d.setMonth(d.getMonth()+interval);
  }
  renderList('pay'); doCalc();
}
function addEv(type){
  let d,v,target=null;
  if(type==='rate'){ d=document.getElementById('rtDate').value; v=parseFloat(document.getElementById('rtVal').value); target=currentRateType; }
  else if(type==='pf'){ d=document.getElementById('pfChDate').value; v=parseFloat(document.getElementById('pfChVal').value); }
  else if(type==='exp'){ d=document.getElementById('expChDate').value; v=parseFloat(document.getElementById('expChVal').value); }
  else{ d=document.getElementById('incDate').value; v=parseFloat(document.getElementById('incVal').value); }
  if(!d||isNaN(v)||v<0) return;
  if(type==='rate'){
    const ex=events.rate.find(e=>e.date===d&&e.target===target);
    if(ex) ex.val=v; else events.rate.push({date:d,val:v,target});
  } else {
    if(!events[type]) events[type]=[];
    const ex=events[type].find(e=>e.date===d);
    if(ex) ex.val=v; else events[type].push({date:d,val:v});
  }
  renderList(type); doCalc();
}
function delEv(type,i){ events[type].splice(i,1); renderList(type); doCalc(); }
function renderList(type){
  if(type==='pay'){
    const el=document.getElementById('list-pay');
    const sorted=[...events.pay].sort((a,b)=>a.date.localeCompare(b.date));
    el.innerHTML=sorted.map((e,i)=>{
      const origIdx=events.pay.indexOf(e);
      const tgtLabel=e.target==='com'?`<span style="font-size:var(--fs-xs);color:var(--primary);font-weight:700">[å•†]</span>`:e.target==='fund'?`<span style="font-size:var(--fs-xs);color:var(--cyan);font-weight:700">[å…¬]</span>`:`<span style="font-size:var(--fs-xs);color:var(--green);font-weight:700">[æ¯”]</span>`;
      const tgtColor=e.target==='com'?'var(--primary)':e.target==='fund'?'var(--cyan)':'var(--green)';
      return `<div class="event-item"><span class="event-date">${e.date} ${tgtLabel}</span><span class="event-val" style="color:${tgtColor}">${(e.val/10000).toFixed(1)}ä¸‡</span><span class="del-btn" onclick="delEv('pay',${origIdx})"><i class="fas fa-times"></i></span></div>`;
    }).join('');
    document.getElementById('payCount').textContent=events.pay.length;
    return;
  }
  const el=document.getElementById('list-'+type);
  if(!el) return;
  const units={rate:'%',pf:'å…ƒ',inc:'å…ƒ',exp:'å…ƒ'};
  const colors={rate:'var(--primary)',pf:'var(--green)',inc:'var(--cyan)',exp:'var(--teal)'};
  const arr=events[type]||[];
  const sorted=[...arr].sort((a,b)=>a.date.localeCompare(b.date));
  el.innerHTML=sorted.map((e)=>{
    const origIdx=arr.indexOf(e);
    const val=type==='inc'?(e.val).toFixed(1):type==='exp'?(e.val).toFixed(1):e.val;
    const tag=type==='rate'?`<span style="font-size:var(--fs-xs);color:${e.target==='com'?'var(--primary)':'var(--cyan)'}">[${e.target==='com'?'å•†':'å…¬'}]</span> `:'';
    return `<div class="event-item"><span class="event-date">${e.date} ${tag}</span><span class="event-val" style="color:${colors[type]}">${val}${units[type]}</span><span class="del-btn" onclick="delEv('${type}',${origIdx})"><i class="fas fa-times"></i></span></div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è´·æ¬¾è®¡ç®—è¾…åŠ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç­‰é¢æœ¬æ¯æœˆä¾›å…¬å¼: PMT = P * r * (1+r)^n / ((1+r)^n - 1)
function PMT(r,n,p){
  if(Math.abs(r)<1e-9) return n>0?p/n:0;
  const x=Math.pow(1+r,n);
  return p*r*x/(x-1);
}
function fmtAlways(n){ return Math.round(n).toLocaleString('zh-CN'); }
function dtiColor(v){ return v>=55?'var(--purple)':v>=50?'var(--red)':v>=40?'var(--yellow)':'var(--green)'; }
function dtiClass(v){ return v>=55?'dti-over':v>=50?'dti-high':v>=40?'dti-warn':'dti-safe'; }

// å¯¹å•ä¸ªè´·æ¬¾æ‰§è¡Œæå‰è¿˜æ¬¾
// mode: 'term'=ç¼©çŸ­å¹´é™, 'amt'=å‡å°‘æœˆä¾›
function _applyPrepayLoan(l, amt, mode){
  if(!l||l.curP<=10) return;
  amt=Math.min(amt,l.curP); // ä¸è¶…è¿‡å‰©ä½™æœ¬é‡‘
  l.curP-=amt;
  if(l.curP>10){
    const remMonths=l.totalM-l.paidM;
    if(remMonths>0){
      if(mode==='term'){
        // ç¼©çŸ­å¹´é™ï¼šæœˆä¾›ä¸å˜ï¼Œé‡æ–°è®¡ç®—å‰©ä½™æœˆæ•°
        if(l.m==='1'){
          if(Math.abs(l.r)<1e-9){
            l.totalM=l.paidM+Math.ceil(l.curP/l.payExact);
          } else {
            // n = log(PMT/(PMT - P*r)) / log(1+r)
            const num=l.payExact;
            const den=l.payExact-l.curP*l.r;
            if(den>0) l.totalM=l.paidM+Math.ceil(Math.log(num/den)/Math.log(1+l.r));
            else l.totalM=l.paidM+1;
          }
        } else {
          // ç­‰é¢æœ¬é‡‘ï¼šæœˆè¿˜æœ¬é‡‘ä¸å˜ï¼Œè‡ªç„¶ç¼©çŸ­
          l.basePrin=l.initBasePrin; // ä¿æŒåŸè¿˜æœ¬é‡‘
          const remM=Math.ceil(l.curP/l.basePrin);
          l.totalM=l.paidM+remM;
        }
      } else {
        // å‡å°‘æœˆä¾›ï¼šæœŸé™ä¸å˜ï¼Œé‡æ–°ç®—æœˆä¾›
        if(l.m==='1'){
          l.payExact=PMT(l.r,remMonths,l.curP);
          l.pay=l.payExact;
        } else {
          l.basePrin=l.curP/remMonths;
        }
      }
    }
  } else {
    l.curP=0;
  }
}

// æŒ‰è¿˜æ¬¾å¯¹è±¡åˆ†é…æå‰è¿˜æ¬¾ï¼ˆå«æº¢å‡ºé€»è¾‘ï¼‰
function _applyPrepay(loans, amt, tgtMode, mode){
  const lCom=loans.find(x=>x.id==='com');
  const lFund=loans.find(x=>x.id==='fund');
  const comAvail=lCom&&lCom.curP>10?lCom.curP:0;
  const fundAvail=lFund&&lFund.curP>10?lFund.curP:0;
  if(tgtMode==='com'){
    const toC=Math.min(amt,comAvail);
    if(toC>0) _applyPrepayLoan(lCom,toC,mode);
    const rem=amt-toC;
    if(rem>10&&fundAvail>0) _applyPrepayLoan(lFund,Math.min(rem,fundAvail),mode);
  } else if(tgtMode==='fund'){
    const toF=Math.min(amt,fundAvail);
    if(toF>0) _applyPrepayLoan(lFund,toF,mode);
    const rem=amt-toF;
    if(rem>10&&comAvail>0) _applyPrepayLoan(lCom,Math.min(rem,comAvail),mode);
  } else {
    // æŒ‰å„è‡ªå‰©ä½™æœ¬é‡‘æ¯”ä¾‹åˆ†é…
    const total=comAvail+fundAvail;
    if(total>0){
      if(comAvail>0) _applyPrepayLoan(lCom,Math.min(amt*(comAvail/total),comAvail),mode);
      if(fundAvail>0) _applyPrepayLoan(lFund,Math.min(amt*(fundAvail/total),fundAvail),mode);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ ¸å¿ƒè®¡ç®—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doCalc(){
  saveSettings();
  const gN=id=>parseFloat(document.getElementById(id).value)||0;
  const start=document.getElementById('startDate').value;
  if(!start) return;

  const baseIncome=gN('income');
  const baseExp=gN('expenses');
  const lType=document.getElementById('loanType').value;
  const pfMode=document.getElementById('pfMode').value;
  const pfStart=document.getElementById('pfStartDate').value||'9999-99';

  const bonusYearStart=parseInt(document.getElementById('bonusYear').value)||0;
  const bonusAmtBase=gN('bonusAmt')*10000; // å…ƒ
  const bonusGrowthRate=gN('bonusGrowth')/100;
  const bonusMonthNum=parseInt(document.getElementById('bonusMonth').value)||12;

  // é»˜è®¤å¹´ç»ˆå¥–ç­–ç•¥
  const defBonusUse=bonusUseMode; // 'prepay'|'save'|'split'
  const defBonusSplitRatio=gN('bonusSplitRatio')/100;
  const defBonusSplitTgt=document.getElementById('bonusSplitTarget').value;
  const defBonusPrepayTgt=document.getElementById('bonusPrepayTarget').value;

  // é€å¹´å¹´ç»ˆå¥–è¦†ç›–ï¼ˆäº‹ä»¶åˆ—è¡¨ï¼‰
  const ybMap={};
  events.yb.forEach(e=>{ ybMap[e.year]=e; });

  // â”€â”€ æ„é€ è´·æ¬¾å¯¹è±¡ â”€â”€
  function makeLoan(id,amt,annualRate,years,method){
    const p=amt*10000;
    const r=annualRate/1200; // æœˆåˆ©ç‡
    const n=years*12;        // æ€»æœŸæ•°
    const m=method;
    const payExact=PMT(r,n,p);
    return {
      id, p, r, n, m,
      curP:p, paidM:0, totalM:n,
      payExact, pay:payExact,
      basePrin:m==='2'?p/n:0, // ç­‰é¢æœ¬é‡‘ï¼šæ¯æœˆè¿˜æœ¬é‡‘
      initBasePrin:m==='2'?p/n:0,
    };
  }

  let loans=[];
  if(lType!=='fund')        loans.push(makeLoan('com',gN('cAmt'),gN('cRate'),gN('cYear'),document.getElementById('cMethod').value));
  if(lType!=='commercial')  loans.push(makeLoan('fund',gN('fAmt'),gN('fRate'),gN('fYear'),document.getElementById('fMethod').value));

  const initDebt=loans.reduce((a,b)=>a+b.p,0);
  if(initDebt<=0) return;

  // â”€â”€ åŸºçº¿åˆ©æ¯ï¼ˆæ— ä»»ä½•æå‰è¿˜æ¬¾ï¼Œç”¨äºè®¡ç®—èŠ‚çœåˆ©æ¯ï¼‰â”€â”€
  let baselineInterest=0;
  {
    let bl=loans.map(l=>({
      ...l, curP:l.p, paidM:0, totalM:l.n,
      payExact:PMT(l.r,l.n,l.p),
      basePrin:l.m==='2'?l.p/l.n:0,
    }));
    for(let i=0;i<600;i++){
      let anyActive=false;
      bl.forEach(l=>{
        if(l.curP<1) return;
        anyActive=true;
        const int=l.curP*l.r;
        const prin=l.m==='1'?Math.min(l.payExact-int,l.curP):Math.min(l.basePrin,l.curP);
        baselineInterest+=int;
        l.curP=Math.max(0,l.curP-prin);
        l.paidM++;
      });
      if(!anyActive) break;
    }
  }

  // â”€â”€ ä¸»å¾ªç¯ â”€â”€
  let rows=[];
  let pfBal=gN('pfBal');
  let pfAdd=gN('pfAdd');
  let curIncome=baseIncome;
  let curExp=baseExp;
  let cumSaving=0;

  let stats={
    totalInt:0, comTotalInt:0, fundTotalInt:0,
    riskMonths:0, maxDeficit:0, maxDeficitDate:'',
    prepayTotal:0, prepayManualTotal:0, prepayBonusTotal:0,
    prepayComTotal:0, prepayFundTotal:0,
    bonusCount:0, bonusTotalAmt:0, bonusPrepayAmt:0, bonusSaveAmt:0,
    dtiCashArr:[], dtiTotalArr:[],
    dtiOverCash:0, dtiOverTotal:0, dtiWarnTotal:0,
    savingFlowArr:[], minSaving:Infinity, minSavingDate:'',
    crossDate:null, goldCross:null,
    halfDebtPaid:null, quarterLeft:null, loanEndDate:null,
    firstComInt:0, firstFundInt:0,  // ç”¨äºå‹åŠ›æµ‹è¯•
    firstCashPay:0,
  };

  let active=true;
  let curD=new Date(start);
  let isFirstMonth=true;

  for(let i=1;i<=600&&active;i++){
    const y=curD.getFullYear();
    const mNum=curD.getMonth()+1;
    const m=String(mNum).padStart(2,'0');
    const ds=`${y}-${m}`;

    // â”€â”€ æ¯å¹´1æœˆï¼ˆä»ç¬¬äºŒå¹´èµ·ï¼‰åº”ç”¨å¢é€Ÿ â”€â”€
    if(i>1&&mNum===1){
      curIncome*=(1+gN('incomeGrowth')/100);
      curExp*=(1+gN('expGrowth')/100);
    }

    // â”€â”€ äº‹ä»¶ï¼šæ”¶å…¥è·³æ¶¨ â”€â”€
    const evInc=events.inc?.find(e=>e.date===ds);
    if(evInc) curIncome=evInc.val;

    // â”€â”€ äº‹ä»¶ï¼šæ”¯å‡ºå˜åŠ¨ â”€â”€
    const evExp=events.exp?.find(e=>e.date===ds);
    if(evExp) curExp=evExp.val;

    // â”€â”€ äº‹ä»¶ï¼šå…¬ç§¯é‡‘æœˆç¼´å˜åŠ¨ â”€â”€
    const evPf=events.pf?.find(e=>e.date===ds);
    if(evPf) pfAdd=evPf.val;

    // â”€â”€ äº‹ä»¶ï¼šåˆ©ç‡å˜åŠ¨ â”€â”€
    let rateNote='';
    const evRtCom=events.rate?.find(e=>e.date===ds&&e.target==='com');
    const evRtFund=events.rate?.find(e=>e.date===ds&&e.target==='fund');
    if(evRtCom){
      const l=loans.find(x=>x.id==='com');
      if(l&&l.curP>0){
        l.r=evRtCom.val/1200;
        const remM=l.totalM-l.paidM;
        if(remM>0){
          l.payExact=PMT(l.r,remM,l.curP);
          l.pay=l.payExact;
        }
        rateNote='å•†è´·åˆ©ç‡å˜';
      }
    }
    if(evRtFund){
      const l=loans.find(x=>x.id==='fund');
      if(l&&l.curP>0){
        l.r=evRtFund.val/1200;
        const remM=l.totalM-l.paidM;
        if(remM>0){
          l.payExact=PMT(l.r,remM,l.curP);
          l.pay=l.payExact;
        }
        rateNote=rateNote?'åˆ©ç‡å˜åŠ¨':'å…¬è´·åˆ©ç‡å˜';
      }
    }

    // â”€â”€ å…¬ç§¯é‡‘æœ¬æœˆå…¥è´¦ â”€â”€
    pfBal+=pfAdd;

    // â”€â”€ å¸¸è§„è¿˜æ¬¾ï¼ˆè®¡ç®—æœ¬æœˆæœ¬æ¯åˆ†è§£ï¼‰â”€â”€
    let mDue=0; // æœ¬æœˆåº”è¿˜æ€»é¢ï¼ˆæœ¬+æ¯ï¼‰
    let mInt=0; // æœ¬æœˆæ€»åˆ©æ¯
    let mPrin=0; // æœ¬æœˆæ€»æœ¬é‡‘
    let lDet=[];

    loans.forEach(l=>{
      if(l.curP<1){
        lDet.push({id:l.id,pay:0,prin:0,int:0});
        return;
      }
      const int=l.curP*l.r;
      let prin,pay;
      if(l.m==='1'){
        // ç­‰é¢æœ¬æ¯ï¼šæœˆä¾›å›ºå®šï¼Œæœ€åä¸€æœŸå¯èƒ½ç•¥æœ‰å·®å¼‚
        pay=l.payExact;
        prin=pay-int;
        if(prin<0) prin=0; // åˆ©ç‡å˜åŠ¨æç«¯æƒ…å†µ
        if(prin>l.curP){ prin=l.curP; pay=prin+int; } // æœ€åä¸€æœŸ
      } else {
        // ç­‰é¢æœ¬é‡‘ï¼šæ¯æœˆè¿˜å›ºå®šæœ¬é‡‘
        prin=Math.min(l.basePrin,l.curP);
        pay=prin+int;
      }
      mDue+=pay;
      mInt+=int;
      mPrin+=prin;
      // æš‚å­˜ï¼Œå¾…æ‰€æœ‰è®¡ç®—å®Œåå†æ›´æ–°æœ¬é‡‘
      l._tmpPrin=prin;
      l._tmpPay=pay;
      l._tmpInt=int;
      if(l.id==='com') stats.comTotalInt+=int;
      if(l.id==='fund') stats.fundTotalInt+=int;
      lDet.push({id:l.id,pay,prin,int});
    });
    stats.totalInt+=mInt;

    // è®°å½•ç¬¬ä¸€ä¸ªæœˆæ•°æ®ï¼ˆç”¨äºå‹åŠ›æµ‹è¯•ï¼‰
    if(isFirstMonth){
      stats.firstCashPay=mDue;
      stats.firstComPay=lDet.find(x=>x.id==='com')?.pay||0;
      stats.firstFundPay=lDet.find(x=>x.id==='fund')?.pay||0;
      stats.firstComRate=(loans.find(x=>x.id==='com')?.r||0)*12*100;
      stats.firstFundRate=(loans.find(x=>x.id==='fund')?.r||0)*12*100;
      stats.firstComAmt=loans.find(x=>x.id==='com')?.p||0;
      stats.firstFundAmt=loans.find(x=>x.id==='fund')?.p||0;
      stats.firstComYear=gN('cYear');
      stats.firstFundYear=gN('fYear');
    }

    // â”€â”€ å…¬ç§¯é‡‘å¯¹å†² â”€â”€
    // å¯¹å†²çš„æ˜¯å½“æœˆåº”è¿˜æœˆä¾›ï¼ˆmDueï¼‰
    let cover=0, yfNote='';
    if(pfMode!=='none'&&ds>=pfStart){
      if(pfMode==='month'){
        cover=Math.min(mDue,pfBal);
        pfBal-=cover;
      } else if(pfMode==='year'&&mNum===1){
        // å¹´åº¦å†²æŠµï¼šç”¨å½“å¹´ç§¯ç´¯çš„å…¬ç§¯é‡‘å†²æŠµå½“æœˆæœˆä¾›ï¼ˆè±¡å¾æ€§ï¼Œå®é™…åº”æŒ‰ä½™é¢å†²ï¼‰
        const maxCover=Math.min(pfBal,mDue);
        if(maxCover>1000){ cover=maxCover; pfBal-=cover; yfNote='å¹´å†²'; }
      }
    }
    const cashPay=Math.max(0,mDue-cover); // éœ€è¦ç°é‡‘æ”¯ä»˜çš„æœˆä¾›

    // â”€â”€ DTI è®¡ç®— â”€â”€
    // ç°é‡‘DTI = ç°é‡‘æœˆä¾› / æœˆæ”¶å…¥ï¼ˆåæ˜ å®é™…ç°é‡‘å‹åŠ›ï¼‰
    // æ€»DTI = (ç°é‡‘æœˆä¾› + å›ºå®šæ”¯å‡º) / æœˆæ”¶å…¥ï¼ˆåæ˜ æ€»è´Ÿæ‹…ï¼‰
    const dtiCash=curIncome>0?(cashPay/curIncome*100):0;
    const dtiTotal=curIncome>0?((cashPay+curExp)/curIncome*100):0;
    stats.dtiCashArr.push({date:ds,y,val:dtiCash});
    stats.dtiTotalArr.push({date:ds,y,val:dtiTotal});
    if(dtiCash>50) stats.dtiOverCash++;
    if(dtiTotal>50) stats.dtiOverTotal++;
    if(dtiTotal>=40&&dtiTotal<=50) stats.dtiWarnTotal++;

    // â”€â”€ æ›´æ–°æœ¬é‡‘ï¼ˆå¸¸è§„è¿˜æ¬¾éƒ¨åˆ†ï¼‰â”€â”€
    loans.forEach(l=>{
      if(l.curP>0&&l._tmpPrin>0){
        l.curP=Math.max(0,l.curP-l._tmpPrin);
        l.paidM++;
      }
    });

    // â”€â”€ å¹´ç»ˆå¥–å¤„ç† â”€â”€
    let bonusThisMonth=0, bonusPrepayThis=0, bonusSaveThis=0;

    if(bonusAmtBase>0&&bonusYearStart>0&&y>=bonusYearStart&&mNum===bonusMonthNum){
      // æœ¬å¹´é‡‘é¢ï¼šä¼˜å…ˆé€å¹´äº‹ä»¶ï¼Œå¦åˆ™ç”¨é»˜è®¤å…¬å¼
      const ov=ybMap[y];
      const yearsElapsed=y-bonusYearStart;
      let thisAmt;
      if(ov&&ov.amt!==null&&ov.amt!==undefined){
        thisAmt=ov.amt*10000; // å…ƒ
      } else {
        thisAmt=bonusAmtBase*Math.pow(1+bonusGrowthRate,yearsElapsed);
      }
      bonusThisMonth=thisAmt;
      stats.bonusCount++;
      stats.bonusTotalAmt+=bonusThisMonth;

      // æœ¬å¹´ç­–ç•¥ï¼šä¼˜å…ˆé€å¹´äº‹ä»¶ï¼Œå¦åˆ™ç”¨é»˜è®¤
      const useMode=(ov&&ov.use&&ov.use!=='default')?ov.use:defBonusUse;
      if(useMode==='split'){
        const ratio=(ov&&ov.use==='split'&&ov.splitRatio!==null)?ov.splitRatio/100:defBonusSplitRatio;
        bonusPrepayThis=bonusThisMonth*ratio;
        bonusSaveThis=bonusThisMonth-bonusPrepayThis;
      } else if(useMode==='save'){
        bonusPrepayThis=0;
        bonusSaveThis=bonusThisMonth;
      } else {
        // prepayï¼ˆé»˜è®¤ï¼‰
        bonusPrepayThis=bonusThisMonth;
        bonusSaveThis=0;
      }

      stats.bonusPrepayAmt+=bonusPrepayThis;
      stats.bonusSaveAmt+=bonusSaveThis;

      // æ‰§è¡Œæå‰è¿˜æ¬¾
      if(bonusPrepayThis>0){
        let tgtMode;
        if(useMode==='split'){
          tgtMode=(ov&&ov.use==='split')?ov.splitTgt:defBonusSplitTgt;
        } else {
          tgtMode=(ov&&ov.use==='prepay')?ov.prepayTgt:defBonusPrepayTgt;
        }
        _applyPrepay(loans,bonusPrepayThis,tgtMode,prepayOption);
        stats.prepayBonusTotal+=bonusPrepayThis;
        stats.prepayTotal+=bonusPrepayThis;
        // æŒ‰æ¯”ä¾‹åˆ†é…åˆ°å•†/å…¬ç»Ÿè®¡ï¼ˆè¿‘ä¼¼ï¼‰
        const lCom=loans.find(x=>x.id==='com');
        const lFund=loans.find(x=>x.id==='fund');
        if(tgtMode==='com'){ stats.prepayComTotal+=bonusPrepayThis; }
        else if(tgtMode==='fund'){ stats.prepayFundTotal+=bonusPrepayThis; }
        else{
          const comW=stats.firstComAmt,fundW=stats.firstFundAmt,total=comW+fundW;
          if(total>0){ stats.prepayComTotal+=bonusPrepayThis*(comW/total); stats.prepayFundTotal+=bonusPrepayThis*(fundW/total); }
        }
      }
    }

    // â”€â”€ æ‰‹åŠ¨æå‰è¿˜æ¬¾äº‹ä»¶ â”€â”€
    let extraCom=0, extraFund=0;
    const evsPay=events.pay?.filter(e=>e.date===ds)||[];
    evsPay.forEach(ev=>{
      const amt=ev.val;
      const lCom=loans.find(x=>x.id==='com');
      const lFund=loans.find(x=>x.id==='fund');
      const comAvail=lCom&&lCom.curP>10?lCom.curP:0;
      const fundAvail=lFund&&lFund.curP>10?lFund.curP:0;
      let toC=0,toF=0;
      if(ev.target==='com'){
        toC=Math.min(amt,comAvail);
        const rem=amt-toC;
        if(rem>10&&fundAvail>0) toF=Math.min(rem,fundAvail);
      } else if(ev.target==='fund'){
        toF=Math.min(amt,fundAvail);
        const rem=amt-toF;
        if(rem>10&&comAvail>0) toC=Math.min(rem,comAvail);
      } else {
        const total=comAvail+fundAvail;
        if(total>0){ toC=amt*(comAvail/total); toF=amt*(fundAvail/total); }
      }
      if(toC>0){ _applyPrepayLoan(lCom,toC,prepayOption); extraCom+=toC; }
      if(toF>0){ _applyPrepayLoan(lFund,toF,prepayOption); extraFund+=toF; }
    });
    const extraTotal=extraCom+extraFund;
    if(extraTotal>0){
      stats.prepayManualTotal+=extraTotal;
      stats.prepayTotal+=extraTotal;
      stats.prepayComTotal+=extraCom;
      stats.prepayFundTotal+=extraFund;
    }

    // â”€â”€ å½“æœˆå‰©ä½™æœ¬é‡‘ â”€â”€
    const remC=Math.max(0,loans.find(x=>x.id==='com')?.curP||0);
    const remF=Math.max(0,loans.find(x=>x.id==='fund')?.curP||0);
    const remDebt=remC+remF;

    // â”€â”€ é‡Œç¨‹ç¢‘æ£€æµ‹ â”€â”€
    if(!stats.halfDebtPaid&&remDebt>0&&remDebt<=initDebt/2) stats.halfDebtPaid=ds;
    if(!stats.quarterLeft&&remDebt>0&&remDebt<=initDebt/4)  stats.quarterLeft=ds;
    if(!stats.goldCross&&mPrin>mInt&&mInt>0)                stats.goldCross=ds;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â˜… æœˆå‡€ç»“ä½™ç²¾ç¡®è®¡ç®— â˜…
    //
    // ç°é‡‘æµå…¥ï¼šæœˆæ”¶å…¥ + å¹´ç»ˆå¥–ä¸­"å‚¨è“„éƒ¨åˆ†"
    //   ï¼ˆå¹´ç»ˆå¥–"è¿˜æ¬¾éƒ¨åˆ†"å±äºç°é‡‘æµå‡ºï¼Œä¸è¿›å‚¨è“„ï¼‰
    // ç°é‡‘æµå‡ºï¼šå›ºå®šæ”¯å‡º + ç°é‡‘æœˆä¾› + æ‰‹åŠ¨æå‰è¿˜æ¬¾
    //   ï¼ˆå¹´ç»ˆå¥–è¿˜æ¬¾å·²åœ¨ bonusPrepayThis ä¸­ï¼Œä½†è¯¥é‡‘é¢
    //    æ¥è‡ªå¹´ç»ˆå¥–æ”¶å…¥ï¼Œå‡€æ•ˆæœ = bonusSaveThis è¿›å‚¨è“„ï¼‰
    //
    // savingFlow = æ”¶å…¥ + å¹´ç»ˆå¥– - å›ºæ”¯ - ç°é‡‘æœˆä¾›
    //              - å¹´ç»ˆå¥–è¿˜æ¬¾éƒ¨åˆ† - æ‰‹åŠ¨æè¿˜
    //           = æ”¶å…¥ + bonusSaveThis - å›ºæ”¯ - ç°é‡‘æœˆä¾› - æ‰‹åŠ¨æè¿˜
    //   ï¼ˆä¸¤ç§å†™æ³•ç­‰ä»·ï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const savingFlow = curIncome + bonusThisMonth - curExp - cashPay - bonusPrepayThis - extraTotal;

    cumSaving+=savingFlow;

    stats.savingFlowArr.push({date:ds,val:savingFlow});
    if(savingFlow<stats.minSaving){ stats.minSaving=savingFlow; stats.minSavingDate=ds; }
    if(savingFlow<0){ stats.riskMonths++; if(savingFlow<stats.maxDeficit){ stats.maxDeficit=savingFlow; stats.maxDeficitDate=ds; } }

    // ä¸Šå²¸ï¼šå‡€å‚¨è“„é¦–æ¬¡è¶…è¿‡å‰©ä½™å€ºåŠ¡
    if(!stats.crossDate&&remDebt>0&&cumSaving>=remDebt) stats.crossDate=ds;

    // â”€â”€ å¤‡æ³¨æ ‡ç­¾ â”€â”€
    let notes=[];
    if(bonusThisMonth>0)  notes.push({t:`å¥–${(bonusThisMonth/10000).toFixed(1)}ä¸‡`,cls:'ntag-bonus'});
    if(extraCom>0)        notes.push({t:'å•†æ',cls:'ntag-prepay-com'});
    if(extraFund>0)       notes.push({t:'å…¬æ',cls:'ntag-prepay-fund'});
    if(bonusPrepayThis>0) notes.push({t:'å¥–è¿˜',cls:'ntag-bonus'});
    if(yfNote)            notes.push({t:'å¹´å†²',cls:'ntag-year'});
    if(rateNote)          notes.push({t:'åˆ©ç‡å˜',cls:'ntag-rate'});
    if(evPf)              notes.push({t:'å…¬ç§¯é‡‘è°ƒ',cls:'ntag-pf'});
    if(evInc)             notes.push({t:'æ”¶å…¥å˜',cls:'ntag-pf'});
    if(evExp)             notes.push({t:'æ”¯å‡ºå˜',cls:'ntag-exp'});

    rows.push({
      y, d:ds,
      inc:Math.round(curIncome), exp:Math.round(curExp),
      bonus:Math.round(bonusThisMonth), bonusPrepay:Math.round(bonusPrepayThis), bonusSave:Math.round(bonusSaveThis),
      totalPay:Math.round(mDue), cashPay:Math.round(cashPay), cover:Math.round(cover),
      savingFlow:Math.round(savingFlow), cumSaving:Math.round(cumSaving),
      dtiCash, dtiTotal,
      rem:remDebt, remC:Math.round(remC), remF:Math.round(remF),
      comPay:Math.round(lDet.find(x=>x.id==='com')?.pay||0),
      comPrin:Math.round(lDet.find(x=>x.id==='com')?.prin||0),
      comInt:Math.round(lDet.find(x=>x.id==='com')?.int||0),
      fundPay:Math.round(lDet.find(x=>x.id==='fund')?.pay||0),
      fundPrin:Math.round(lDet.find(x=>x.id==='fund')?.prin||0),
      fundInt:Math.round(lDet.find(x=>x.id==='fund')?.int||0),
      extraCom:Math.round(extraCom), extraFund:Math.round(extraFund),
      notes,
      hasPrepay:extraTotal>0, hasRate:!!rateNote, hasPfChange:!!evPf,
      hasBonus:bonusThisMonth>0, hasExpChange:!!evExp,
    });

    isFirstMonth=false;

    // è´·æ¬¾è¿˜æ¸…
    if(remDebt<10&&extraTotal===0&&bonusPrepayThis===0){
      stats.loanEndDate=ds; active=false;
    }
    curD.setMonth(curD.getMonth()+1);
  }

  fullData=rows;
  if(rows.length){
    if(!curViewYear||curViewYear<rows[0].y||curViewYear>rows[rows.length-1].y)
      curViewYear=rows[0].y;
    renderUI(stats, initDebt, baselineInterest);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ¸²æŸ“ UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderUI(stats, initDebt, baselineInterest){
  const total=fullData.length;
  const lastRow=fullData[total-1];
  const firstRow=fullData[0];
  const finalCumSaving=lastRow.cumSaving;
  const cashDTIArr=stats.dtiCashArr.map(d=>d.val);
  const totalDTIArr=stats.dtiTotalArr.map(d=>d.val);
  const avgCashDTI=cashDTIArr.reduce((a,b)=>a+b,0)/total;
  const avgTotalDTI=totalDTIArr.reduce((a,b)=>a+b,0)/total;
  const maxCashDTI=Math.max(...cashDTIArr);
  const maxCashDTIIdx=cashDTIArr.indexOf(maxCashDTI);
  const maxTotalDTI=Math.max(...totalDTIArr);

  // èŠ‚çœåˆ©æ¯ = åŸºçº¿åˆ©æ¯ - å®é™…åˆ©æ¯ï¼ˆæ­£å€¼=èŠ‚çœï¼Œè´Ÿå€¼ä¸åº”å‡ºç°ï¼‰
  const interestSaved=Math.max(0, baselineInterest-stats.totalInt);

  // KPI
  document.getElementById('kpi-int').textContent=(stats.totalInt/10000).toFixed(2);
  document.getElementById('kpi-ratio').textContent=((stats.totalInt/initDebt)*100).toFixed(1)+'%';
  document.getElementById('kpi-net').textContent=(finalCumSaving/10000).toFixed(2);
  document.getElementById('kpi-dti').textContent=firstRow.dtiCash.toFixed(1)+'%';
  document.getElementById('kpi-date').textContent=stats.crossDate||'æœªä¸Šå²¸';

  renderCharts(stats);

  // â”€â”€ æœˆä»½åˆ†å¸ƒç»Ÿè®¡ â”€â”€
  const safeMo=cashDTIArr.filter(v=>v<40).length;
  const warnMo=cashDTIArr.filter(v=>v>=40&&v<50).length;
  const overMo=cashDTIArr.filter(v=>v>=50).length;
  const safeP=(safeMo/total*100).toFixed(0);
  const warnP=(warnMo/total*100).toFixed(0);
  const overP=(overMo/total*100).toFixed(0);

  let html='';

  // â”€â”€ 1. DTI æŠ¥å‘Šï¼ˆä»¥ç°é‡‘DTIåˆ†æ®µï¼Œæ€»DTIè¾…åŠ©å±•ç¤ºï¼‰â”€â”€
  html+=`<div class="report-block">
  <div class="rb-head" style="color:var(--purple)"><i class="fas fa-percentage"></i> DTIå…¨å‘¨æœŸç²¾ç¡®è¿½è¸ªï¼ˆå…±${total}ä¸ªæœˆï¼‰</div>
  <div class="rb-body">
    <div style="font-size:var(--fs-xs);color:var(--text3);margin-bottom:4px">ç°é‡‘DTI = ç°é‡‘æœˆä¾› / æœˆæ”¶å…¥ï¼ˆè¿›åº¦æ¡æŒ‰ç°é‡‘DTIåˆ†æ®µï¼‰</div>
    <div class="dti-progress-row">
      <div class="dti-prog-safe" style="width:${safeP}%"></div>
      <div class="dti-prog-warn" style="width:${warnP}%"></div>
      <div class="dti-prog-high" style="width:${overP}%"></div>
    </div>
    <div style="display:flex;gap:10px;font-size:var(--fs-xs);color:var(--text3);margin-bottom:8px;flex-wrap:wrap">
      <span style="color:var(--green)">â— å®‰å…¨(&lt;40%) ${safeMo}æœˆ</span>
      <span style="color:var(--yellow)">â— è­¦å‘Š(40-50%) ${warnMo}æœˆ</span>
      <span style="color:var(--red)">â— è¶…æ ‡(â‰¥50%) ${overMo}æœˆ</span>
    </div>
    <div class="stat-grid-4">
      <div class="stat-cell"><div class="stat-cell-val" style="color:${dtiColor(firstRow.dtiCash)}">${firstRow.dtiCash.toFixed(1)}%</div><div class="stat-cell-lbl">é¦–æœˆç°é‡‘DTI</div><div class="stat-cell-sub">${firstRow.d}</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:${dtiColor(firstRow.dtiTotal)}">${firstRow.dtiTotal.toFixed(1)}%</div><div class="stat-cell-lbl">é¦–æœˆæ€»DTI</div><div class="stat-cell-sub">å«å›ºæ”¯</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:${dtiColor(avgCashDTI)}">${avgCashDTI.toFixed(1)}%</div><div class="stat-cell-lbl">å‡å€¼ç°é‡‘DTI</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:${dtiColor(maxCashDTI)}">${maxCashDTI.toFixed(1)}%</div><div class="stat-cell-lbl">å³°å€¼ç°é‡‘DTI</div><div class="stat-cell-sub">${stats.dtiCashArr[maxCashDTIIdx]?.date||''}</div></div>
    </div>
    ${bi(firstRow.dtiCash>=50,'bad',`é¦–æœˆç°é‡‘DTI ${firstRow.dtiCash.toFixed(1)}%ï¼Œå·²è¶…50%å‹åŠ›çº¿ï¼Œé“¶è¡Œå®¡æ‰¹å­˜é£é™©`)}
    ${bi(firstRow.dtiCash>=40&&firstRow.dtiCash<50,'warn',`é¦–æœˆç°é‡‘DTI ${firstRow.dtiCash.toFixed(1)}%ï¼Œå¤„äº40-50%è­¦æˆ’åŒºé—´`)}
    ${bi(firstRow.dtiCash<40,'ok',`é¦–æœˆç°é‡‘DTI ${firstRow.dtiCash.toFixed(1)}%ï¼Œç¬¦åˆé“¶è¡Œä¸»æµå®¡æ‰¹è¦æ±‚ï¼ˆ<40%ï¼‰`)}
    ${bi(firstRow.dtiTotal>=60,'bad',`é¦–æœˆæ€»DTIï¼ˆå«å›ºæ”¯ï¼‰${firstRow.dtiTotal.toFixed(1)}%ï¼Œè¶…è¿‡60%ï¼Œæ•´ä½“è´¢åŠ¡å‹åŠ›è¾ƒå¤§`)}
    ${bi(firstRow.dtiTotal>=50&&firstRow.dtiTotal<60,'warn',`é¦–æœˆæ€»DTIï¼ˆå«å›ºæ”¯ï¼‰${firstRow.dtiTotal.toFixed(1)}%ï¼Œå¤„äºè­¦æˆ’åŒºé—´`)}
    ${bi(overMo>0,'warn',`å…± ${overMo} ä¸ªæœˆç°é‡‘DTIâ‰¥50%ï¼Œå»ºè®®ä¿ç•™6ä¸ªæœˆä»¥ä¸Šåº”æ€¥å‚¨å¤‡`)}
    ${bi(overMo===0&&avgCashDTI<35,'ok','å…¨å‘¨æœŸç°é‡‘DTIå‡åœ¨å®‰å…¨åŒºé—´ï¼Œè´¢åŠ¡ç¨³å¥')}
  </div></div>`;

  // â”€â”€ 2. å¹´ç»ˆå¥–æŠ¥å‘Š â”€â”€
  if(stats.bonusCount>0){
    html+=`<div class="report-block">
  <div class="rb-head" style="color:var(--bonus)"><i class="fas fa-gift"></i> å¹´ç»ˆå¥–è§„åˆ’åˆ†æï¼ˆå…±${stats.bonusCount}æ¬¡ï¼‰</div>
  <div class="rb-body">
    <div class="stat-grid-4">
      <div class="stat-cell"><div class="stat-cell-val" style="color:var(--bonus)">${(stats.bonusTotalAmt/10000).toFixed(1)}ä¸‡</div><div class="stat-cell-lbl">ç´¯è®¡å¹´ç»ˆå¥–</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:var(--orange)">${(stats.bonusPrepayAmt/10000).toFixed(1)}ä¸‡</div><div class="stat-cell-lbl">ç”¨äºè¿˜æ¬¾</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:var(--green)">${(stats.bonusSaveAmt/10000).toFixed(1)}ä¸‡</div><div class="stat-cell-lbl">ç”¨äºå‚¨è“„</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:var(--red)">${(interestSaved/10000).toFixed(2)}ä¸‡</div><div class="stat-cell-lbl">æ‰€æœ‰æå‰è¿˜æ¬¾èŠ‚çœåˆ©æ¯</div></div>
    </div>
    <div class="formula">å¹´ç»ˆå¥–è¿˜æ¬¾é¢ ${(stats.bonusPrepayAmt/10000).toFixed(1)}ä¸‡ + æ‰‹åŠ¨æå‰è¿˜æ¬¾ ${(stats.prepayManualTotal/10000).toFixed(1)}ä¸‡ = åˆè®¡ ${(stats.prepayTotal/10000).toFixed(1)}ä¸‡</div>
    ${bi(stats.bonusPrepayAmt>0&&interestSaved>0,'ok',`æå‰è¿˜æ¬¾å…±èŠ‚çœåˆ©æ¯ ${(interestSaved/10000).toFixed(2)} ä¸‡å…ƒï¼ˆå«å¹´ç»ˆå¥–+æ‰‹åŠ¨è¿˜æ¬¾ï¼‰`)}
    ${bi(stats.bonusSaveAmt>stats.bonusPrepayAmt,'info','å¹´ç»ˆå¥–ä»¥å‚¨è“„ä¸ºä¸»ï¼ŒæµåŠ¨æ€§å……è£•')}
    ${bi(stats.bonusPrepayAmt>stats.bonusTotalAmt*0.7,'info',`è¶…è¿‡70%å¹´ç»ˆå¥–ç”¨äºæå‰è¿˜æ¬¾ï¼Œå¯æ˜¾è‘—å‹ç¼©è¿˜è´·å‘¨æœŸ`)}
  </div></div>`;
  }

  // â”€â”€ 3. å‹åŠ›æµ‹è¯•ï¼ˆè®¡ç®—æ›´ç²¾ç¡®ï¼‰â”€â”€
  // é¦–æœˆç°é‡‘æœˆä¾›ï¼ˆæœªç»å…¬ç§¯é‡‘å†²æŠµå‰ï¼‰= firstRow.totalPay
  // åˆ©ç‡+50BPï¼šæ–°æœˆä¾› = PMT(r+0.5/1200, n, P) è¿‘ä¼¼ firstRow.totalPay*(1+0.005/(12*r))
  // æ›´å‡†ç¡®ï¼šç›´æ¥é‡æ–°ç®—
  const initComR=stats.firstComRate/1200||0;
  const initFundR=stats.firstFundRate/1200||0;
  const comP=stats.firstComAmt||0;
  const fundP=stats.firstFundAmt||0;
  const comN=stats.firstComYear*12||0;
  const fundN=stats.firstFundYear*12||0;
  const baseTotalPay=firstRow.totalPay;
  // è®¡ç®—+50BPåˆ©ç‡ä¸‹çš„æœˆä¾›
  function newPayBp(bp){
    let t=0;
    if(comP>0&&comN>0) t+=PMT(initComR+bp/1200,comN,comP);
    if(fundP>0&&fundN>0) t+=PMT(initFundR+bp/1200,fundN,fundP);
    return t;
  }
  const pay50=newPayBp(50);
  const pay100=newPayBp(100);
  const dtiStress80=firstRow.inc>0?(baseTotalPay/(firstRow.inc*0.8)*100):0;
  const expUp20=(firstRow.cashPay+firstRow.exp*1.2)/firstRow.inc*100;
  const dtiAt50bp=firstRow.inc>0?(pay50/firstRow.inc*100):0;
  const dtiAt100bp=firstRow.inc>0?(pay100/firstRow.inc*100):0;

  html+=`<div class="report-block">
  <div class="rb-head" style="color:var(--red)"><i class="fas fa-flask"></i> å‹åŠ›æƒ…æ™¯æ¨¡æ‹Ÿï¼ˆåŸºäºé¦–æœˆæ•°æ®ï¼‰</div>
  <div class="rb-body">
    <div class="stress-grid">`;
  [
    {label:'æ”¶å…¥-20%ï¼Œç°é‡‘DTI',val:dtiStress80.toFixed(1)+'%',ok:dtiStress80<50},
    {label:'å›ºæ”¯+20%ï¼Œæ€»DTI', val:expUp20.toFixed(1)+'%',ok:expUp20<60},
    {label:'åˆ©ç‡+50BPï¼Œæœˆä¾›DTI',val:dtiAt50bp.toFixed(1)+'%',ok:dtiAt50bp<50},
    {label:'åˆ©ç‡+100BPï¼Œæœˆä¾›DTI',val:dtiAt100bp.toFixed(1)+'%',ok:dtiAt100bp<50},
    {label:'å½“å‰æ€»DTIï¼ˆå«å›ºæ”¯ï¼‰',val:firstRow.dtiTotal.toFixed(1)+'%',ok:firstRow.dtiTotal<50},
    {label:'å¤±ä¸š6æœˆç°é‡‘æµå‡ºï¼ˆæœˆä¾›Ã—6ï¼‰',val:fmtAlways(firstRow.cashPay*6)+'å…ƒ',ok:true},
  ].forEach(s=>{
    const c=s.ok?'var(--green)':'var(--red)';
    html+=`<div class="stress-cell"><div class="stress-val" style="color:${c}">${s.ok?'âœ“':'âš '} ${s.val}</div><div class="stress-lbl">${s.label}</div></div>`;
  });
  html+=`</div>
    ${bi(!stats.firstComRate&&!stats.firstFundRate,'info','æ— è´·æ¬¾ä¿¡æ¯ï¼Œå‹åŠ›æµ‹è¯•ä»…ä¾›å‚è€ƒ')}
  </div></div>`;

  // â”€â”€ 4. é‡Œç¨‹ç¢‘ â”€â”€
  html+=`<div class="report-block">
  <div class="rb-head" style="color:var(--yellow)"><i class="fas fa-flag-checkered"></i> è¿˜è´·é‡Œç¨‹ç¢‘</div>
  <div class="rb-body milestone-list">`;
  [{label:'ğŸ¦ è¿˜æ¸…ä¸€åŠå€ºåŠ¡',date:stats.halfDebtPaid||'â€”',ok:!!stats.halfDebtPaid},
   {label:'âš¡ æœˆè¿˜æœ¬é‡‘>æœˆè¿˜åˆ©æ¯ï¼ˆé»„é‡‘äº¤å‰ï¼‰',date:stats.goldCross||'â€”',ok:!!stats.goldCross},
   {label:'ğŸ¯ å‰©ä½™å€ºåŠ¡ä»…25%',date:stats.quarterLeft||'â€”',ok:!!stats.quarterLeft},
   {label:'ğŸ å‡€å‚¨è“„é¦–æ¬¡è¶…è¿‡å‰©ä½™å€ºåŠ¡ï¼ˆä¸Šå²¸ï¼‰',date:stats.crossDate||'â€”',ok:!!stats.crossDate},
   {label:'ğŸ‰ è´·æ¬¾å…¨éƒ¨è¿˜æ¸…',date:stats.loanEndDate||'â€”',ok:!!stats.loanEndDate},
  ].forEach(ms=>{
    const c=ms.ok?'var(--green)':'var(--text3)';
    html+=`<div class="milestone"><span class="ms-label">${ms.label}</span><span style="display:flex;align-items:center;gap:7px"><span class="ms-date" style="color:${c}">${ms.date}</span><span style="color:${c}">${ms.ok?'âœ“':'â—‹'}</span></span></div>`;
  });
  html+=`</div></div>`;

  // â”€â”€ 5. ç°é‡‘æµå¥åº·åº¦ â”€â”€
  const avgSavingFlow=stats.savingFlowArr.reduce((a,b)=>a+b.val,0)/total;
  html+=`<div class="report-block">
  <div class="rb-head" style="color:var(--cyan)"><i class="fas fa-heartbeat"></i> ç°é‡‘æµå¥åº·åº¦</div>
  <div class="rb-body">
    <div class="stat-grid-4">
      <div class="stat-cell"><div class="stat-cell-val" style="color:${avgSavingFlow>0?'var(--green)':'var(--red)'}">${(avgSavingFlow/10000).toFixed(2)}ä¸‡</div><div class="stat-cell-lbl">æœˆå‡å‡€ç»“ä½™</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:${stats.minSaving>=0?'var(--yellow)':'var(--red)'}">${(stats.minSaving/10000).toFixed(2)}ä¸‡</div><div class="stat-cell-lbl">æœ€ä½æœˆç»“ä½™</div><div class="stat-cell-sub">${stats.minSavingDate}</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:${stats.riskMonths>0?'var(--red)':'var(--green)'}">${stats.riskMonths}</div><div class="stat-cell-lbl">è´Ÿç»“ä½™æœˆæ•°</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:var(--cyan)">${(finalCumSaving/10000).toFixed(1)}ä¸‡</div><div class="stat-cell-lbl">æœŸæœ«å‡€å‚¨è“„</div></div>
    </div>
    <div class="formula" style="font-size:9px">æœˆå‡€ç»“ä½™ = æœˆæ”¶å…¥ + å¹´ç»ˆå¥– - å›ºå®šæ”¯å‡º - ç°é‡‘æœˆä¾› - å¹´ç»ˆå¥–è¿˜æ¬¾é¢ - æ‰‹åŠ¨æå‰è¿˜æ¬¾</div>
    ${bi(stats.riskMonths>0,'bad',`å…± ${stats.riskMonths} ä¸ªæœˆæœˆå‡€ç»“ä½™ä¸ºè´Ÿï¼Œæœ€å¤§ç¼ºå£ ${fmtAlways(Math.abs(stats.maxDeficit))} å…ƒï¼ˆ${stats.maxDeficitDate}ï¼‰ï¼Œéœ€æå‰å¤‡è¶³ç°é‡‘`)}
    ${bi(stats.riskMonths===0&&avgSavingFlow>5000,'ok','å…¨å‘¨æœŸæœˆå‡€ç»“ä½™å‡ä¸ºæ­£ï¼Œç°é‡‘æµå¥åº·')}
    ${bi(stats.riskMonths===0&&avgSavingFlow<=5000&&avgSavingFlow>0,'warn','æœˆå‡ç»“ä½™åä½ï¼Œå»ºè®®ç»´æŒè‡³å°‘6ä¸ªæœˆæœˆä¾›çš„åº”æ€¥å‚¨å¤‡')}
    ${bi(finalCumSaving<0,'bad',`æœŸæœ«å‡€å‚¨è“„ä¸ºè´Ÿ ${(Math.abs(finalCumSaving)/10000).toFixed(1)} ä¸‡å…ƒï¼Œæ•´ä½“å…¥ä¸æ•·å‡º`)}
    ${bi(finalCumSaving>=0&&finalCumSaving<initDebt*0.3,'warn',`æœŸæœ«å‡€å‚¨è“„ä»… ${(finalCumSaving/10000).toFixed(1)} ä¸‡å…ƒï¼Œå è´·æ¬¾æœ¬é‡‘ ${(finalCumSaving/initDebt*100).toFixed(0)}%`)}
    ${bi(finalCumSaving>=initDebt*0.3,'ok',`æœŸæœ«å‡€å‚¨è“„ ${(finalCumSaving/10000).toFixed(1)} ä¸‡å…ƒï¼Œè´¢å¯Œç§¯ç´¯çŠ¶å†µè‰¯å¥½`)}
  </div></div>`;

  // â”€â”€ 6. æå‰è¿˜æ¬¾æ•ˆç›Šï¼ˆä»…åœ¨æœ‰æå‰è¿˜æ¬¾æ—¶æ˜¾ç¤ºï¼‰â”€â”€
  if(stats.prepayTotal>0){
    html+=`<div class="report-block">
  <div class="rb-head" style="color:var(--orange)"><i class="fas fa-bolt"></i> æå‰è¿˜æ¬¾æ•ˆç›Šæ ¸ç®—</div>
  <div class="rb-body">
    <div class="stat-grid-3">
      <div class="stat-cell"><div class="stat-cell-val" style="color:var(--orange)">${(stats.prepayTotal/10000).toFixed(1)}ä¸‡</div><div class="stat-cell-lbl">ç´¯è®¡æå‰è¿˜æ¬¾</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:var(--green)">${(interestSaved/10000).toFixed(2)}ä¸‡</div><div class="stat-cell-lbl">èŠ‚çœåˆ©æ¯ï¼ˆå¯¹æ¯”ä¸è¿˜ï¼‰</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:var(--cyan)">${stats.prepayTotal>0?(interestSaved/stats.prepayTotal*100).toFixed(1):0}%</div><div class="stat-cell-lbl">æ¯å…ƒæè¿˜èŠ‚çœåˆ©æ¯</div></div>
    </div>
    <div class="stat-grid" style="margin-top:5px">
      <div class="stat-cell"><div class="stat-cell-val" style="color:var(--primary)">${(stats.prepayComTotal/10000).toFixed(1)}ä¸‡</div><div class="stat-cell-lbl">â†’å•†è´·éƒ¨åˆ†</div></div>
      <div class="stat-cell"><div class="stat-cell-val" style="color:var(--cyan)">${(stats.prepayFundTotal/10000).toFixed(1)}ä¸‡</div><div class="stat-cell-lbl">â†’å…¬ç§¯é‡‘éƒ¨åˆ†</div></div>
    </div>
    ${bi(interestSaved>stats.prepayTotal*0.3,'ok',`èŠ‚çœåˆ©æ¯/è¿˜æ¬¾é¢ = ${(interestSaved/Math.max(1,stats.prepayTotal)*100).toFixed(1)}%ï¼Œæå‰è¿˜æ¬¾æ•ˆç›Šæ˜¾è‘—`)}
    ${bi(interestSaved>0&&interestSaved<=stats.prepayTotal*0.3,'info',`èŠ‚çœåˆ©æ¯/è¿˜æ¬¾é¢ = ${(interestSaved/Math.max(1,stats.prepayTotal)*100).toFixed(1)}%ï¼Œæå‰è¿˜æ¬¾æœ‰ä¸€å®šæ•ˆç›Š`)}
  </div></div>`;
  }

  document.getElementById('reportContent').innerHTML=html;
  renderTableHeader();
  renderTable();
}

function bi(cond,type,text){
  if(!cond) return '';
  const icons={ok:`<i class="fas fa-check-circle" style="color:var(--green)"></i>`,warn:`<i class="fas fa-exclamation-circle" style="color:var(--yellow)"></i>`,bad:`<i class="fas fa-times-circle" style="color:var(--red)"></i>`,info:`<i class="fas fa-info-circle" style="color:var(--primary)"></i>`};
  return `<div class="insight-row ${type}"><span class="insight-icon">${icons[type]||''}</span><span>${text}</span></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å›¾è¡¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharts(stats){
  // æŒ‰å¹´ä»½èšåˆ
  let byYear={};
  fullData.forEach(r=>{
    if(!byYear[r.y]) byYear[r.y]={cumSaving:0,rem:r.rem,bonusCum:0};
    byYear[r.y].cumSaving=r.cumSaving;
    byYear[r.y].rem=r.rem;
    if(r.bonus>0) byYear[r.y].bonusCum=(byYear[r.y].bonusCum||0)+r.bonus;
  });
  // å¹´ç»ˆå¥–ç´¯è®¡ï¼ˆè·¨å¹´ç´¯åŠ ï¼‰
  let runBonus=0;
  Object.keys(byYear).sort((a,b)=>a-b).forEach(y=>{
    runBonus+=(byYear[y].bonusCum||0);
    byYear[y].bonusCumTotal=runBonus;
  });
  const yrs=Object.keys(byYear).sort((a,b)=>a-b);
  const bonusData=yrs.map(y=>+((byYear[y].bonusCumTotal||0)/10000).toFixed(1));
  const hasBonusData=bonusData.some(v=>v>0);

  const ctxR=document.getElementById('chartRace').getContext('2d');
  if(chartRace) chartRace.destroy();
  const raceDS=[
    {label:'å‰©ä½™å€ºåŠ¡',data:yrs.map(y=>+(byYear[y].rem/10000).toFixed(1)),borderColor:'#e05252',borderWidth:2,pointRadius:0,fill:false,tension:.3},
    {label:'å‡€å‚¨è“„',  data:yrs.map(y=>+(Math.max(0,byYear[y].cumSaving)/10000).toFixed(1)),borderColor:'#38a169',borderWidth:2,pointRadius:0,fill:true,backgroundColor:'rgba(56,161,105,.08)',tension:.3},
  ];
  if(hasBonusData) raceDS.push({label:'å¹´ç»ˆå¥–ç´¯è®¡',data:bonusData,borderColor:'#9b4dca',borderWidth:1.5,borderDash:[4,3],pointRadius:0,fill:false,tension:.3});
  chartRace=new Chart(ctxR,{type:'line',data:{labels:yrs,datasets:raceDS},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{backgroundColor:'#fff',borderColor:'#d8e1ec',borderWidth:1,titleColor:'#2d3748',bodyColor:'#4a5568',callbacks:{label:ctx=>`${ctx.dataset.label}: ${ctx.raw.toFixed(1)}ä¸‡`}}},scales:{x:{grid:{color:'rgba(216,225,236,.5)'},ticks:{color:'#8a9ab5',font:{size:10}}},y:{grid:{color:'rgba(216,225,236,.5)'},ticks:{color:'#8a9ab5',font:{size:10},callback:v=>v+'ä¸‡'}}}}});

  // DTI å›¾ï¼ˆé‡‡æ ·é¿å…è¿‡å¯†ï¼‰
  const step=Math.max(1,Math.floor(fullData.length/80));
  const sampled=fullData.filter((_,i)=>i%step===0||i===fullData.length-1);
  const maxDTI=Math.max(80,Math.ceil(Math.max(...stats.dtiTotalArr.map(d=>d.val))/10)*10+10);
  const ctxD=document.getElementById('chartDTI').getContext('2d');
  if(chartDTI) chartDTI.destroy();
  chartDTI=new Chart(ctxD,{type:'line',data:{labels:sampled.map(r=>r.d),datasets:[
    {label:'ç°é‡‘DTI',data:sampled.map(r=>+r.dtiCash.toFixed(1)),borderColor:'#7c5cbf',borderWidth:1.5,pointRadius:0,fill:false,tension:.3},
    {label:'æ€»DTI',  data:sampled.map(r=>+r.dtiTotal.toFixed(1)),borderColor:'#d97706',borderWidth:1.5,pointRadius:0,fill:false,tension:.3},
    {label:'50%çº¿',  data:sampled.map(()=>50),borderColor:'rgba(224,82,82,.5)',borderWidth:1,borderDash:[4,4],pointRadius:0,fill:false},
    {label:'40%çº¿',  data:sampled.map(()=>40),borderColor:'rgba(217,119,6,.3)',borderWidth:1,borderDash:[2,4],pointRadius:0,fill:false},
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:false},tooltip:{backgroundColor:'#fff',borderColor:'#d8e1ec',borderWidth:1,titleColor:'#2d3748',bodyColor:'#4a5568',callbacks:{label:ctx=>{if(ctx.dataset.label==='50%çº¿'||ctx.dataset.label==='40%çº¿') return null;return `${ctx.dataset.label}: ${ctx.raw}%`;}}}},scales:{x:{grid:{color:'rgba(216,225,236,.5)'},ticks:{color:'#8a9ab5',font:{size:10},maxTicksLimit:8}},y:{min:0,max:maxDTI,grid:{color:'rgba(216,225,236,.5)'},ticks:{color:'#8a9ab5',font:{size:10},callback:v=>v+'%'}}}}});

  // é¥¼å›¾ï¼šæœ¬é‡‘+åˆ©æ¯
  const ctxP=document.getElementById('chartPie').getContext('2d');
  if(chartPie) chartPie.destroy();
  chartPie=new Chart(ctxP,{type:'doughnut',data:{labels:['å•†è´·æœ¬é‡‘','å…¬è´·æœ¬é‡‘','å•†è´·åˆ©æ¯','å…¬è´·åˆ©æ¯'],datasets:[{data:[
    +((fullData[0].remC)/10000).toFixed(1),
    +((fullData[0].remF)/10000).toFixed(1),
    +(stats.comTotalInt/10000).toFixed(1),
    +(stats.fundTotalInt/10000).toFixed(1),
  ],backgroundColor:['#5a8dee','#2b8fa3','rgba(90,141,238,.28)','rgba(43,143,163,.28)'],borderColor:'#ffffff',borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'#fff',borderColor:'#d8e1ec',borderWidth:1,titleColor:'#2d3748',bodyColor:'#4a5568',callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw}ä¸‡`}}}}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¡¨æ ¼æ¸²æŸ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable(){
  document.getElementById('dispYear').textContent=curViewYear;
  const tbody=document.getElementById('tbody');
  tbody.innerHTML='';
  const cols=visibleCols();
  fullData.filter(r=>r.y===curViewYear).forEach(r=>{
    const tr=document.createElement('tr');
    if(r.savingFlow<0)    tr.classList.add('row-risk');
    else if(r.hasBonus)   tr.classList.add('row-bonus');
    else if(r.hasPrepay)  tr.classList.add('row-prepay');
    else if(r.hasRate)    tr.classList.add('row-rate');
    cols.forEach((c,ci)=>{
      const td=document.createElement('td');
      const prevGrp=ci>0?cols[ci-1].group:null;
      if(c.grpSep&&prevGrp&&prevGrp!==c.group) td.classList.add('grp-sep');
      switch(c.key){
        case 'month': td.textContent=r.d; break;
        case 'inc':   td.textContent=fmtAlways(r.inc); td.classList.add('val-blue'); break;
        case 'exp':
          td.textContent=fmtAlways(r.exp);
          if(r.hasExpChange){td.style.color='var(--teal)';td.style.fontWeight='700';}
          else td.style.color='var(--text3)';
          break;
        case 'totalPay': td.textContent=fmtAlways(r.totalPay); break;
        case 'cashPay':  td.textContent=fmtAlways(r.cashPay); td.classList.add('val-neg'); break;
        case 'cover':
          td.textContent=r.cover>0?fmtAlways(r.cover):'â€”';
          td.style.color=r.cover>0?'var(--green)':'var(--text3)';
          break;
        case 'savingFlow':
          td.textContent=fmtAlways(r.savingFlow);
          td.classList.add(r.savingFlow>=0?'val-pos':'val-neg'); break;
        case 'cumSaving':
          td.textContent=fmtAlways(r.cumSaving);
          td.classList.add(r.cumSaving>=0?'val-pos':'val-neg'); break;
        case 'dtiCash':
          td.textContent=r.dtiCash.toFixed(1)+'%';
          td.className=(td.className?td.className+' ':'')+'dti-cell '+dtiClass(r.dtiCash); break;
        case 'dtiTotal':
          td.textContent=r.dtiTotal.toFixed(1)+'%';
          td.className=(td.className?td.className+' ':'')+'dti-cell '+dtiClass(r.dtiTotal); break;
        case 'comPay':
          td.textContent=r.comPay>0?fmtAlways(r.comPay):'â€”';
          td.style.color=r.comPay>0?'var(--primary)':'var(--text3)'; break;
        case 'comPrin':
          td.textContent=r.comPrin>0?fmtAlways(r.comPrin):'â€”';
          if(!r.comPrin) td.style.color='var(--text3)'; break;
        case 'comInt':
          td.textContent=r.comInt>0?fmtAlways(r.comInt):'â€”';
          if(r.comInt>0) td.classList.add('val-neg'); else td.style.color='var(--text3)'; break;
        case 'remC': td.textContent=fmtAlways(r.remC); break;
        case 'fundPay':
          td.textContent=r.fundPay>0?fmtAlways(r.fundPay):'â€”';
          td.style.color=r.fundPay>0?'var(--cyan)':'var(--text3)'; break;
        case 'fundPrin':
          td.textContent=r.fundPrin>0?fmtAlways(r.fundPrin):'â€”';
          if(!r.fundPrin) td.style.color='var(--text3)'; break;
        case 'fundInt':
          td.textContent=r.fundInt>0?fmtAlways(r.fundInt):'â€”';
          if(r.fundInt>0) td.classList.add('val-neg'); else td.style.color='var(--text3)'; break;
        case 'remF': td.textContent=fmtAlways(r.remF); break;
        case 'extraCom':
          td.textContent=r.extraCom>0?fmtAlways(r.extraCom):'â€”';
          td.style.color=r.extraCom>0?'var(--primary)':'var(--text3)'; break;
        case 'extraFund':
          td.textContent=r.extraFund>0?fmtAlways(r.extraFund):'â€”';
          td.style.color=r.extraFund>0?'var(--cyan)':'var(--text3)'; break;
        case 'bonus':
          td.textContent=r.bonus>0?fmtAlways(r.bonus):'â€”';
          if(r.bonus>0) td.classList.add('val-bonus'); else td.style.color='var(--text3)'; break;
        case 'bonusPrepay':
          td.textContent=r.bonusPrepay>0?fmtAlways(r.bonusPrepay):'â€”';
          if(r.bonusPrepay>0) td.classList.add('val-orange'); else td.style.color='var(--text3)'; break;
        case 'bonusSave':
          td.textContent=r.bonusSave>0?fmtAlways(r.bonusSave):'â€”';
          if(r.bonusSave>0) td.classList.add('val-pos'); else td.style.color='var(--text3)'; break;
        case 'notes':
          td.style.textAlign='left';
          td.style.fontFamily="'Noto Sans SC',sans-serif";
          td.innerHTML=r.notes.map(n=>`<span class="ntag ${n.cls}">${n.t}</span>`).join(''); break;
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å¯¼å‡º Excel
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportExcel(){
  if(!fullData.length) return;
  const ws=XLSX.utils.json_to_sheet(fullData.map(r=>({
    'æœˆä»½':r.d,'æœˆæ”¶å…¥':r.inc,'å›ºå®šæ”¯å‡º':r.exp,
    'å¹´ç»ˆå¥–':r.bonus||'','å¹´ç»ˆå¥–-è¿˜æ¬¾':r.bonusPrepay||'','å¹´ç»ˆå¥–-å‚¨è“„':r.bonusSave||'',
    'æœˆä¾›æ€»é¢':r.totalPay,'å…¬ç§¯é‡‘å†²æŠµ':r.cover||'','ç°é‡‘æœˆä¾›':r.cashPay,
    'æœˆå‡€ç»“ä½™':r.savingFlow,'ç´¯è®¡å‡€å‚¨è“„':r.cumSaving,
    'ç°é‡‘DTI%':+r.dtiCash.toFixed(2),'æ€»DTI%':+r.dtiTotal.toFixed(2),
    'å•†è´·æœˆä¾›':r.comPay||'','å•†è´·æœ¬é‡‘':r.comPrin||'','å•†è´·åˆ©æ¯':r.comInt||'','å•†è´·ä½™é¢':r.remC,
    'å…¬è´·æœˆä¾›':r.fundPay||'','å…¬è´·æœ¬é‡‘':r.fundPrin||'','å…¬è´·åˆ©æ¯':r.fundInt||'','å…¬è´·ä½™é¢':r.remF,
    'å•†è´·æ‰‹åŠ¨æè¿˜':r.extraCom||'','å…¬è´·æ‰‹åŠ¨æè¿˜':r.extraFund||'',
  })));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'æ¨æ¼”æ˜ç»†');
  XLSX.writeFile(wb,`æˆ¿è´·æ¨æ¼”v10_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æœ¬åœ°å­˜å‚¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSettings(){
  const d={events,prepayOption,singleTarget,regTarget,currentRateType,bonusUseMode,colGroups,inputs:{}};
  document.querySelectorAll('input,select').forEach(el=>{
    if(el.id&&!['pyDate','pyAmt','rtDate','rtVal','pfChDate','pfChVal','expChDate','expChVal',
                 'regStart','regInterval','regAmt','regTimes','incDate','incVal',
                 'ybYear','ybAmt','ybSplitRatio'].includes(el.id))
      d.inputs[el.id]=el.value;
  });
  try{localStorage.setItem('mortgage_v100',JSON.stringify(d));}catch(e){}
}
function loadSettings(){
  try{
    const keys=['mortgage_v100','mortgage_v90','mortgage_v85'];
    let s=null;
    for(const k of keys){ s=localStorage.getItem(k); if(s) break; }
    if(!s) return false;
    const d=JSON.parse(s);
    for(const k in d.inputs){const el=document.getElementById(k);if(el) el.value=d.inputs[k];}
    if(d.events){
      events={pay:[],rate:[],pf:[],inc:[],exp:[],yb:[],...d.events};
      if(!events.exp) events.exp=[];
      if(!events.yb) events.yb=[];
    }
    events.pay=events.pay.map(e=>({...e,target:e.target||'com'}));
    if(d.prepayOption){prepayOption=d.prepayOption;selPrepayOpt(prepayOption);}
    if(d.singleTarget){singleTarget=d.singleTarget;selSingleTarget(singleTarget);}
    if(d.regTarget){regTarget=d.regTarget;selRegTarget(regTarget);}
    if(d.currentRateType){currentRateType=d.currentRateType;selRateType(currentRateType);}
    if(d.bonusUseMode){bonusUseMode=d.bonusUseMode;selBonusUse(bonusUseMode);}
    if(d.colGroups){
      colGroups={...colGroups,...d.colGroups};
      Object.keys(colGroups).forEach(g=>{const btn=document.getElementById('tog-'+g);if(btn) btn.classList.toggle('on',colGroups[g]);});
    }
    ['pay','rate','pf','inc','exp'].forEach(t=>renderList(t));
    renderYbList();
    return true;
  }catch(e){return false;}
}
</script>
</body>
</html>
